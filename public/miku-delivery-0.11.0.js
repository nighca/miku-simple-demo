var mikuDelivery=function(D){"use strict";var Ds=Object.defineProperty,Ls=Object.defineProperties;var Bs=Object.getOwnPropertyDescriptors;var He=Object.getOwnPropertySymbols;var yn=Object.prototype.hasOwnProperty,Rn=Object.prototype.propertyIsEnumerable;var yt=(D,P,B)=>P in D?Ds(D,P,{enumerable:!0,configurable:!0,writable:!0,value:B}):D[P]=B,_=(D,P)=>{for(var B in P||(P={}))yn.call(P,B)&&yt(D,B,P[B]);if(He)for(var B of He(P))Rn.call(P,B)&&yt(D,B,P[B]);return D},F=(D,P)=>Ls(D,Bs(P));var Rt=(D,P)=>{var B={};for(var q in D)yn.call(D,q)&&P.indexOf(q)<0&&(B[q]=D[q]);if(D!=null&&He)for(var q of He(D))P.indexOf(q)<0&&Rn.call(D,q)&&(B[q]=D[q]);return B};var R=(D,P,B)=>(yt(D,typeof P!="symbol"?P+"":P,B),B);var v=(D,P,B)=>new Promise((q,ae)=>{var ze=J=>{try{pe(B.next(J))}catch(me){ae(me)}},Ne=J=>{try{pe(B.throw(J))}catch(me){ae(me)}},pe=J=>J.done?q(J.value):Promise.resolve(J.value).then(ze,Ne);pe((B=B.apply(D,P)).next())});function P(r){const e=[],t=r.length;for(let n=0;n<t;n++){let s=r.charCodeAt(n);if(s>=55296&&s<=56319&&t>n+1){const i=r.charCodeAt(n+1);i>=56320&&i<=57343&&(s=(s-55296)*1024+i-56320+65536,n+=1)}if(s<128){e.push(s);continue}if(s<2048){e.push(s>>6|192),e.push(s&63|128);continue}if(s<55296||s>=57344&&s<65536){e.push(s>>12|224),e.push(s>>6&63|128),e.push(s&63|128);continue}if(s>=65536&&s<=1114111){e.push(s>>18|240),e.push(s>>12&63|128),e.push(s>>6&63|128),e.push(s&63|128);continue}e.push(239,191,189)}return new Uint8Array(e).buffer}function B(r){return r^=r>>>16,r=Math.imul(r,2246822507),r^=r>>>13,r=Math.imul(r,3266489909),r^=r>>>16,r>>>0}const q=new Uint32Array([3432918353,461845907]);function ae(r,e){return r<<e|r>>>32-e}function ze(r,e){const t=r.byteLength/4|0,n=new Uint32Array(r,0,t);for(let s=0;s<t;s++)n[s]=Math.imul(n[s],q[0]),n[s]=ae(n[s],15),n[s]=Math.imul(n[s],q[1]),e[0]=e[0]^n[s],e[0]=ae(e[0],13),e[0]=Math.imul(e[0],5)+3864292196}function Ne(r,e){const t=r.byteLength/4|0,n=r.byteLength%4;let s=0;const i=new Uint8Array(r,t*4,n);switch(n){case 3:s=s^i[2]<<16;case 2:s=s^i[1]<<8;case 1:s=s^i[0]<<0,s=Math.imul(s,q[0]),s=ae(s,15),s=Math.imul(s,q[1]),e[0]=e[0]^s}}function pe(r,e){e[0]=e[0]^r.byteLength,e[0]=B(e[0])}function J(r,e){if(e=e?e|0:0,typeof r=="string"&&(r=P(r)),!(r instanceof ArrayBuffer))throw new TypeError("Expected key to be ArrayBuffer or string");const t=new Uint32Array([e]);return ze(r,t),Ne(r,t),pe(r,t),t.buffer}class me{constructor(e=xn){R(this,"circle",new Map);R(this,"members",new Set);R(this,"membersReplicas",new Map);R(this,"sortedHashes",[]);this.hasher=e}updateSortedHashes(){this.sortedHashes=[...this.circle.keys()].sort((e,t)=>e-t)}_add({key:e,replicas:t}){for(let n=0;n<t;n++){const s=this.hasher(xt(e,n));this.circle.set(s,e)}this.members.add(e),this.membersReplicas.set(e,t)}_remove({key:e,replicas:t}){for(let n=0;n<t;n++){const s=this.hasher(xt(e,n));this.circle.delete(s)}this.members.delete(e),this.membersReplicas.delete(e)}search(e){const t=this.sortedHashes.findIndex(n=>n>e);return t<0?0:t}get(e){if(this.members.size===0)return null;const t=this.hasher(e),n=this.search(t),s=this.sortedHashes[n];return this.circle.get(s)}getN(e,t){const n=this.members.size;if(n===0||t===0)return[];t>n&&(t=n);const s=this.hasher(e),i=this.search(s),o=[];for(let a=i;;a++){a>=this.sortedHashes.length&&(a=0);const c=this.sortedHashes[a],d=this.circle.get(c);if(!o.includes(d)&&(o.push(d),o.length>=t))return o}}add(e,t){return this.members.has(e)?!1:(this._add({key:e,replicas:t}),this.updateSortedHashes(),!0)}remove(e){if(!this.members.has(e))return!1;const t=this.membersReplicas.get(e);return this._remove({key:e,replicas:t}),this.updateSortedHashes(),!0}set(e){this.circle.clear(),this.members.clear(),this.membersReplicas.clear(),e.forEach(t=>{this._add(t)}),this.updateSortedHashes()}}function xt(r,e){return e+r}const xn=Cn;function Cn(r){const e=J(r);return new Uint32Array(e)[0]}class ee{constructor(e){R(this,"value");this.value=e!=null?_({},e.value):{}}set(e,t){this.value[e]=t}get(e){return this.value[e]}}let Ct=!1;function te(r){return(...e)=>{Ct&&console.debug(`[${r}] [${(Date.now()/1e3).toFixed(3)}]`,...e)}}function St(){Ct=!0}const Ue="https://api.qiniudns.com/v1/resolve",Et="https://log.qiniuapi.com",qe="https://pili-zeus.qiniuapi.com/v1/scheduling";function Sn(r){r[0]==="?"&&(r=r.slice(1));const e={};return r.split("&").forEach(t=>{const[n,s]=t.split("=");e[decodeURIComponent(n)]=s==null?null:decodeURIComponent(s)}),e}function We(r){return Object.keys(r).map(e=>[e,r[e]]).filter(([e,t])=>t!==void 0).map(([e,t])=>t===null?encodeURIComponent(e):[e,t].map(encodeURIComponent).join("=")).join("&")}function En(r,e){const t=new URLSearchParams(e).toString(),n=r.includes("?")?"&":"?";return r+n+t}function Fe(){const r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",e=r.length;let t="";for(let n=0;n<20;n++)t+=r[Math.floor(Math.random()*e)];return t}function _n(r,e){const t={};return Object.keys(r).forEach(n=>{t[n]=e(r[n])}),t}class _t extends Error{constructor(){super(...arguments);R(this,"name","TimeoutError")}}function Tt(r,e){return new Promise((t,n)=>{setTimeout(()=>n(new _t(e+" timeout")),r)})}function Tn(r,e){e.aborted?r.abort(e.reason):e.addEventListener("abort",()=>{r.abort(e.reason)})}const At={image:[/\.(jpe?g|png|gif|webp|svg|bmp|ico|tiff|avif|svga)$/],media:[/\.(3gp|aac|flac|mpe?g|mp3|mp4|m4a|m4v|m4p|oga|ogg|ogv|wav|webm|mov)$/],live:[/\.(flv|m3u8|ts|m4s)$/],other:[]};function An(r,e,t=["image","media","other"]){r.search="",r.hash="";const n=r.toString();return t.some(s=>{var i;return((i=e[s])!=null?i:[]).some(o=>o.test(n))})}function Ee(r){const e=new URL(r);return e.search="",e.hash="",e.toString()}function le(r){return r instanceof Error?{err_msg:r.name,err_desc:r.message}:{err_msg:"Unknown",err_desc:r+""}}function H(r,e){return r==null||r===-1||e==null||e===-1?-1:(r-e)/1e3}function kn(r,e=80){const[t,n]=r.split(":"),s=n?parseInt(n,10):e;return[t,s]}function kt(r){const e=r.split("/"),t=e[e.length-1],n=t.lastIndexOf(".");return n>=0?t.slice(n+1):""}function Dn(r,e){return new URL(r,e).toString()}function _e(r){const[e]=r.split("?");return e.endsWith(".m3u8")}function Dt(r){const[e]=r.split("?");return e.endsWith(".flv")}var ne=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function Ln(r){var e=r.default;if(typeof e=="function"){var t=function(){return e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(r).forEach(function(n){var s=Object.getOwnPropertyDescriptor(r,n);Object.defineProperty(t,n,s.get?s:{enumerable:!0,get:function(){return r[n]}})}),t}var Lt={exports:{}};function Bn(r){throw new Error('Could not dynamically require "'+r+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var $e={exports:{}};const Pn=Ln(Object.freeze(Object.defineProperty({__proto__:null,default:{}},Symbol.toStringTag,{value:"Module"})));var Bt;function Te(){return Bt||(Bt=1,function(r,e){(function(t,n){r.exports=n()})(ne,function(){var t=t||function(n,s){var i;if(typeof window!="undefined"&&window.crypto&&(i=window.crypto),typeof self!="undefined"&&self.crypto&&(i=self.crypto),typeof globalThis!="undefined"&&globalThis.crypto&&(i=globalThis.crypto),!i&&typeof window!="undefined"&&window.msCrypto&&(i=window.msCrypto),!i&&typeof ne!="undefined"&&ne.crypto&&(i=ne.crypto),!i&&typeof Bn=="function")try{i=Pn}catch(p){}var o=function(){if(i){if(typeof i.getRandomValues=="function")try{return i.getRandomValues(new Uint32Array(1))[0]}catch(p){}if(typeof i.randomBytes=="function")try{return i.randomBytes(4).readInt32LE()}catch(p){}}throw new Error("Native crypto module could not be used to get secure random number.")},a=Object.create||function(){function p(){}return function(g){var y;return p.prototype=g,y=new p,p.prototype=null,y}}(),c={},d=c.lib={},h=d.Base=function(){return{extend:function(p){var g=a(this);return p&&g.mixIn(p),(!g.hasOwnProperty("init")||this.init===g.init)&&(g.init=function(){g.$super.init.apply(this,arguments)}),g.init.prototype=g,g.$super=this,g},create:function(){var p=this.extend();return p.init.apply(p,arguments),p},init:function(){},mixIn:function(p){for(var g in p)p.hasOwnProperty(g)&&(this[g]=p[g]);p.hasOwnProperty("toString")&&(this.toString=p.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),m=d.WordArray=h.extend({init:function(p,g){p=this.words=p||[],g!=s?this.sigBytes=g:this.sigBytes=p.length*4},toString:function(p){return(p||f).stringify(this)},concat:function(p){var g=this.words,y=p.words,x=this.sigBytes,T=p.sigBytes;if(this.clamp(),x%4)for(var O=0;O<T;O++){var K=y[O>>>2]>>>24-O%4*8&255;g[x+O>>>2]|=K<<24-(x+O)%4*8}else for(var U=0;U<T;U+=4)g[x+U>>>2]=y[U>>>2];return this.sigBytes+=T,this},clamp:function(){var p=this.words,g=this.sigBytes;p[g>>>2]&=4294967295<<32-g%4*8,p.length=n.ceil(g/4)},clone:function(){var p=h.clone.call(this);return p.words=this.words.slice(0),p},random:function(p){for(var g=[],y=0;y<p;y+=4)g.push(o());return new m.init(g,p)}}),l=c.enc={},f=l.Hex={stringify:function(p){for(var g=p.words,y=p.sigBytes,x=[],T=0;T<y;T++){var O=g[T>>>2]>>>24-T%4*8&255;x.push((O>>>4).toString(16)),x.push((O&15).toString(16))}return x.join("")},parse:function(p){for(var g=p.length,y=[],x=0;x<g;x+=2)y[x>>>3]|=parseInt(p.substr(x,2),16)<<24-x%8*4;return new m.init(y,g/2)}},u=l.Latin1={stringify:function(p){for(var g=p.words,y=p.sigBytes,x=[],T=0;T<y;T++){var O=g[T>>>2]>>>24-T%4*8&255;x.push(String.fromCharCode(O))}return x.join("")},parse:function(p){for(var g=p.length,y=[],x=0;x<g;x++)y[x>>>2]|=(p.charCodeAt(x)&255)<<24-x%4*8;return new m.init(y,g)}},w=l.Utf8={stringify:function(p){try{return decodeURIComponent(escape(u.stringify(p)))}catch(g){throw new Error("Malformed UTF-8 data")}},parse:function(p){return u.parse(unescape(encodeURIComponent(p)))}},b=d.BufferedBlockAlgorithm=h.extend({reset:function(){this._data=new m.init,this._nDataBytes=0},_append:function(p){typeof p=="string"&&(p=w.parse(p)),this._data.concat(p),this._nDataBytes+=p.sigBytes},_process:function(p){var g,y=this._data,x=y.words,T=y.sigBytes,O=this.blockSize,K=O*4,U=T/K;p?U=n.ceil(U):U=n.max((U|0)-this._minBufferSize,0);var G=U*O,se=n.min(G*4,T);if(G){for(var $=0;$<G;$+=O)this._doProcessBlock(x,$);g=x.splice(0,G),y.sigBytes-=se}return new m.init(g,se)},clone:function(){var p=h.clone.call(this);return p._data=this._data.clone(),p},_minBufferSize:0});d.Hasher=b.extend({cfg:h.extend(),init:function(p){this.cfg=this.cfg.extend(p),this.reset()},reset:function(){b.reset.call(this),this._doReset()},update:function(p){return this._append(p),this._process(),this},finalize:function(p){p&&this._append(p);var g=this._doFinalize();return g},blockSize:16,_createHelper:function(p){return function(g,y){return new p.init(y).finalize(g)}},_createHmacHelper:function(p){return function(g,y){return new A.HMAC.init(p,y).finalize(g)}}});var A=c.algo={};return c}(Math);return t})}($e)),$e.exports}var je={exports:{}},Pt;function Mn(){return Pt||(Pt=1,function(r,e){(function(t,n){r.exports=n(Te())})(ne,function(t){return function(){var n=t,s=n.lib,i=s.WordArray,o=s.Hasher,a=n.algo,c=[],d=a.SHA1=o.extend({_doReset:function(){this._hash=new i.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(h,m){for(var l=this._hash.words,f=l[0],u=l[1],w=l[2],b=l[3],A=l[4],p=0;p<80;p++){if(p<16)c[p]=h[m+p]|0;else{var g=c[p-3]^c[p-8]^c[p-14]^c[p-16];c[p]=g<<1|g>>>31}var y=(f<<5|f>>>27)+A+c[p];p<20?y+=(u&w|~u&b)+1518500249:p<40?y+=(u^w^b)+1859775393:p<60?y+=(u&w|u&b|w&b)-1894007588:y+=(u^w^b)-899497514,A=b,b=w,w=u<<30|u>>>2,u=f,f=y}l[0]=l[0]+f|0,l[1]=l[1]+u|0,l[2]=l[2]+w|0,l[3]=l[3]+b|0,l[4]=l[4]+A|0},_doFinalize:function(){var h=this._data,m=h.words,l=this._nDataBytes*8,f=h.sigBytes*8;return m[f>>>5]|=128<<24-f%32,m[(f+64>>>9<<4)+14]=Math.floor(l/4294967296),m[(f+64>>>9<<4)+15]=l,h.sigBytes=m.length*4,this._process(),this._hash},clone:function(){var h=o.clone.call(this);return h._hash=this._hash.clone(),h}});n.SHA1=o._createHelper(d),n.HmacSHA1=o._createHmacHelper(d)}(),t.SHA1})}(je)),je.exports}var Ve={exports:{}},Mt;function On(){return Mt||(Mt=1,function(r,e){(function(t,n){r.exports=n(Te())})(ne,function(t){(function(){var n=t,s=n.lib,i=s.Base,o=n.enc,a=o.Utf8,c=n.algo;c.HMAC=i.extend({init:function(d,h){d=this._hasher=new d.init,typeof h=="string"&&(h=a.parse(h));var m=d.blockSize,l=m*4;h.sigBytes>l&&(h=d.finalize(h)),h.clamp();for(var f=this._oKey=h.clone(),u=this._iKey=h.clone(),w=f.words,b=u.words,A=0;A<m;A++)w[A]^=1549556828,b[A]^=909522486;f.sigBytes=u.sigBytes=l,this.reset()},reset:function(){var d=this._hasher;d.reset(),d.update(this._iKey)},update:function(d){return this._hasher.update(d),this},finalize:function(d){var h=this._hasher,m=h.finalize(d);h.reset();var l=h.finalize(this._oKey.clone().concat(m));return l}})})()})}(Ve)),Ve.exports}(function(r,e){(function(t,n,s){r.exports=n(Te(),Mn(),On())})(ne,function(t){return t.HmacSHA1})})(Lt);const In=Lt.exports;var Ot={exports:{}};(function(r,e){(function(t,n){r.exports=n(Te())})(ne,function(t){return function(){var n=t,s=n.lib,i=s.WordArray,o=n.enc;o.Base64={stringify:function(c){var d=c.words,h=c.sigBytes,m=this._map;c.clamp();for(var l=[],f=0;f<h;f+=3)for(var u=d[f>>>2]>>>24-f%4*8&255,w=d[f+1>>>2]>>>24-(f+1)%4*8&255,b=d[f+2>>>2]>>>24-(f+2)%4*8&255,A=u<<16|w<<8|b,p=0;p<4&&f+p*.75<h;p++)l.push(m.charAt(A>>>6*(3-p)&63));var g=m.charAt(64);if(g)for(;l.length%4;)l.push(g);return l.join("")},parse:function(c){var d=c.length,h=this._map,m=this._reverseMap;if(!m){m=this._reverseMap=[];for(var l=0;l<h.length;l++)m[h.charCodeAt(l)]=l}var f=h.charAt(64);if(f){var u=c.indexOf(f);u!==-1&&(d=u)}return a(c,d,m)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="};function a(c,d,h){for(var m=[],l=0,f=0;f<d;f++)if(f%4){var u=h[c.charCodeAt(f-1)]<<f%4*2,w=h[c.charCodeAt(f)]>>>6-f%4*2,b=u|w;m[l>>>2]|=b<<24-l%4*8,l++}return i.create(m,l)}}(),t.enc.Base64})})(Ot);const Hn=Ot.exports;function zn(r){let e=r.query?`${r.path}?${r.query}
`:`${r.path}
`;return r.body&&(e+=r.body),e}function Ke(r){let e;try{e=new URL(r.path).pathname}catch(a){e=r.path}let t=zn(F(_({},r),{path:e}));const i=In(t,r.appSalt).toString(Hn).replace(/\+/g,"-").replace(/\//g,"_");let o=`QApp ${r.appID}:${i}`;return o=o.replace(/\//g,"_"),o=o.replace(/\+/g,"-"),o}class Nn{constructor(e){this.logger=e}log(e){return this.logger.log("DnsResolveLog",e)}}function Un(r){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",t=e.length;let n="";for(let s=0;s<r;s++)n+=e[Math.floor(Math.random()*t)];return n}const qn=new URL(Ue).hostname;function Wn(r,e,t,n){return v(this,null,function*(){var m,l;const s=new Nn(n),i=We({name:e,type:"A",rid:Un(10)}),o=`${Ue}?${i}`,a=Ke(F(_({},t),{path:Ue,query:i}));let c,d=null,h=null;try{if(d=yield fetch(o,{headers:{Authorization:a}}),!d.ok){const u=yield jn(d);if(u==null)throw new Error(`Resolve failed, unexpected HTTP status: ${d.status}`);if(u.code==="NotSupportedArea")return{reason:"NotSupportedArea",ttl:300};throw new Error(`Resolve failed, code: ${u.code}, error: ${u.error}`)}return h=yield d.json()}catch(f){throw c=f}finally{const u=performance.getEntriesByName(o,"resource").pop();if(u==null)console.warn("Corresponding performance entry not found for",o);else{const w=h==null?le(c):{err_msg:"",err_desc:""};s.log(F(_({r_id:(m=d==null?void 0:d.headers.get("x-reqid"))!=null?m:"",ip:"",domain:qn,status_code:(l=d==null?void 0:d.status)!=null?l:-1},w),{t_conn:(u.connectEnd-u.connectStart)/1e3,t_total:(u.responseEnd-u.fetchStart)/1e3,type:1}))}}})}function Ge(r){return r.groups!=null}function Fn(r,e){return r.find(t=>new RegExp(t.pattern).test(e))}function $n(r){return Math.random()<r.servicerate}function jn(r){return v(this,null,function*(){try{const e=yield r.json();if(e&&typeof e.code=="string"&&typeof e.error=="string")return e}catch(e){}return null})}function It(r){return v(this,null,function*(){const t=(yield indexedDB.databases()).filter(n=>n.name!=null&&r.includes(n.name));yield Promise.all(t.map(n=>indexedDB.deleteDatabase(n.name)))})}class Ht{constructor(e,t){R(this,"db");this.dbName=e,this.storeConfigs=t}getDB(){return v(this,null,function*(){return this.db!=null?this.db:new Promise(e=>{const t=indexedDB.open(this.dbName);t.addEventListener("upgradeneeded",()=>{for(const n of this.storeConfigs){const s=t.result.createObjectStore(n.name);for(const i of n.indexes)s.createIndex(i.name,i.keyPath)}}),e(Ae(t))})})}get(e,t){return v(this,null,function*(){const s=(yield this.getDB()).transaction(e,"readonly").objectStore(e).get(t);return Ae(s)})}getAll(e){return v(this,null,function*(){const n=(yield this.getDB()).transaction(e,"readonly").objectStore(e).getAll();return Ae(n)})}count(e){return v(this,null,function*(){const n=(yield this.getDB()).transaction(e,"readonly").objectStore(e).count();return Ae(n)})}set(e,t,n){return v(this,null,function*(){const i=(yield this.getDB()).transaction(e,"readwrite");return i.objectStore(e).put(n,t),Xe(i)})}remove(e,t){return v(this,null,function*(){const s=(yield this.getDB()).transaction(e,"readwrite");return s.objectStore(e).delete(t),Xe(s)})}clear(){return v(this,null,function*(){const e=yield this.getDB();yield Promise.all(this.storeConfigs.map(({name:t})=>{const n=e.transaction(t,"readwrite");return n.objectStore(t).clear(),Xe(n)}))})}walkBy(e,t,n){return v(this,null,function*(){const i=(yield this.getDB()).transaction(e,"readonly").objectStore(e).index(t).openCursor(void 0,"next");return new Promise((o,a)=>{i.addEventListener("error",()=>a(new ge(i.error))),i.addEventListener("success",()=>{const c=i.result;if(c==null){o();return}n(c.value,c.primaryKey),c.continue()})})})}dispose(){var e;(e=this.db)==null||e.close()}}class ge extends Error{constructor(t){super(t+"");R(this,"name","IndexedDBError");this.cause=t}}function Ae(r){return new Promise((e,t)=>{r.addEventListener("success",()=>e(r.result)),r.addEventListener("error",()=>t(new ge(r.error)))})}function Xe(r){return new Promise((e,t)=>{r.addEventListener("complete",()=>e()),r.addEventListener("error",()=>t(new ge(r.error))),r.addEventListener("abort",()=>t(new ge(r.error)))})}class Vn{constructor(){R(this,"map",new Map)}on(e,t){var i;const s=[...(i=this.map.get(e))!=null?i:[],t];return this.map.set(e,s),()=>this.off(e,t)}once(e,t){const n=this.on(e,s=>{n(),t(s)});return n}off(e,t){var i;const s=((i=this.map.get(e))!=null?i:[]).filter(o=>o!==t);this.map.set(e,s)}emit(...e){var i;const[t,n]=e;((i=this.map.get(t))!=null?i:[]).forEach(o=>{o(n)})}dispose(){this.map.clear()}}function ce(r){const e=r.get("Content-Length");return e?parseInt(e,10):null}function Qe(r){const e=r.get("Content-Range");return e==null?null:Kn(e)}function Kn(r){const e=r.trim().toLowerCase(),[t,n]=e.split(/\s+/);if(t!=="bytes")throw new Error(`Unit must be bytes: ${r}`);const[s,i]=n.split("/"),o=i==="*"?null:Ye(i),[a,c]=(s.includes("-")?s.split("-"):[null,null]).map(d=>Ye(d));return{totalSize:o,start:a,end:c}}function zt(r){const e=r.start!=null&&r.end!=null?`${r.start}-${r.end}`:"*",t=r.totalSize==null?"*":r.totalSize+"";return`bytes ${e}/${t}`}function Ye(r){return r?Number(r):null}function Ze(r){const e=r.get("Range");return e==null?null:Ut(e)}function Nt(r){return r.start===0&&r.end==null}function Ut(r){const e=r.trim().toLowerCase();if(!e.startsWith("bytes="))throw new Error(`Unit must be bytes: ${r}`);if(e.includes(","))throw new Error(`Multiple range: ${r}`);const[,t,n]=/(\d*)-(\d*)/.exec(e)||[];if(!t&&!n)throw new Error(`Invalid range values: ${r}`);if(!t)throw new Error("Suffix range not supported");const[s,i]=[t,n].map(o=>Ye(o));return{start:s,end:i}}function be(r){var e,t;return`bytes=${(e=r.start)!=null?e:0}-${(t=r.end)!=null?t:""}`}const Gn=/[^\u0000-\u00ff]/;function qt(r){return Gn.test(r)?"REPLACED_BY_Miku_Delivery_SEE_utils_http_encodeHeaderValue":r}function Xn(r){if(r instanceof Headers){const e={};r.forEach((t,n)=>{e[n]=qt(t)}),r=e}if(Array.isArray(r)){const e={};r.forEach(([t,n])=>{e[n]=qt(t)}),r=e}return new Headers(r)}function Wt(r){var t;const e=Qe(r);return e!=null?(t=e.totalSize)!=null?t:null:ce(r)}function Qn(r){return v(this,null,function*(){const e=r.getReader();let t=new Uint8Array;for(;;){const{done:s,value:i}=yield e.read();if(s)break;t=new Uint8Array([...t,...i])}return new TextDecoder().decode(t)})}function Je(r,e){var a;const t=r.getReader(),n=(a=e[0])!=null?a:0,s=e[1];let i=0;return new ReadableStream({pull:c=>v(this,null,function*(){let d,h;for(;;){const u=yield t.read();if(u.done){c.close();return}if(d=u.value,h=i+d.byteLength,h>n)break;i=h}let m=d;const l=n>i?n-i:0,f=s!=null&&s<h?s-i:void 0;(l!==0||f!==void 0)&&(m=d.slice(l,f)),c.enqueue(m),s!=null&&h>=s&&(t.cancel("Cancelled by slice for target range met"),c.close()),i=h}),cancel:c=>t.cancel(c)})}function Yn(r){let e=0;const t=new TransformStream({transform:(s,i)=>{e+=s.byteLength,i.enqueue(s)}}),n=r.pipeTo(t.writable).then(()=>({size:e,success:!0}),s=>({size:e,success:!1,error:s}));return[t.readable,n]}function Zn(r){let e,t=!1;const n=new ReadableStream({start:a=>{e=a},cancel:()=>{t=!0}}),s=r.getReader();let i=!1;return{main:new ReadableStream({pull:a=>v(this,null,function*(){try{const{value:c,done:d}=yield s.read();if(i)return;if(d){a.close(),t||e.close();return}a.enqueue(c),t||e.enqueue(c)}catch(c){a.error(c),t||e.error(c)}}),cancel:a=>v(this,null,function*(){i=!0,yield s.cancel(a),e.error(a)})}),minor:n}}var et={exports:{}};(function(r,e){(function(t,n){var s="1.0.2",i="",o="?",a="function",c="undefined",d="object",h="string",m="major",l="model",f="name",u="type",w="vendor",b="version",A="architecture",p="console",g="mobile",y="tablet",x="smarttv",T="wearable",O="embedded",K=255,U="Amazon",G="Apple",se="ASUS",$="BlackBerry",V="Browser",N="Chrome",X="Edge",W="Firefox",Y="Google",j="Huawei",z="LG",wt="Microsoft",dn="Motorola",Pe="Opera",pt="Samsung",mt="Sony",fn="Xiaomi",gt="Zebra",wn="Facebook",Ts=function(C,k){var S={};for(var I in C)k[I]&&k[I].length%2===0?S[I]=k[I].concat(C[I]):S[I]=C[I];return S},Me=function(C){for(var k={},S=0;S<C.length;S++)k[C[S].toUpperCase()]=C[S];return k},pn=function(C,k){return typeof C===h?xe(k).indexOf(xe(C))!==-1:!1},xe=function(C){return C.toLowerCase()},As=function(C){return typeof C===h?C.replace(/[^\d\.]/g,i).split(".")[0]:n},bt=function(C,k){if(typeof C===h)return C=C.replace(/^\s\s*/,i).replace(/\s\s*$/,i),typeof k===c?C:C.substring(0,K)},Ce=function(C,k){for(var S=0,I,E,Ie,L,Se,Z;S<k.length&&!Se;){var bn=k[S],vn=k[S+1];for(I=E=0;I<bn.length&&!Se;)if(Se=bn[I++].exec(C),Se)for(Ie=0;Ie<vn.length;Ie++)Z=Se[++E],L=vn[Ie],typeof L===d&&L.length>0?L.length===2?typeof L[1]==a?this[L[0]]=L[1].call(this,Z):this[L[0]]=L[1]:L.length===3?typeof L[1]===a&&!(L[1].exec&&L[1].test)?this[L[0]]=Z?L[1].call(this,Z,L[2]):n:this[L[0]]=Z?Z.replace(L[1],L[2]):n:L.length===4&&(this[L[0]]=Z?L[3].call(this,Z.replace(L[1],L[2])):n):this[L]=Z||n;S+=2}},vt=function(C,k){for(var S in k)if(typeof k[S]===d&&k[S].length>0){for(var I=0;I<k[S].length;I++)if(pn(k[S][I],C))return S===o?n:S}else if(pn(k[S],C))return S===o?n:S;return C},ks={"1.0":"/8","1.2":"/1","1.3":"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"},mn={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2","8.1":"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},gn={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[b,[f,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[b,[f,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[f,b],[/opios[\/ ]+([\w\.]+)/i],[b,[f,Pe+" Mini"]],[/\bopr\/([\w\.]+)/i],[b,[f,Pe]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale|qqbrowserlite|qq)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[f,b],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[b,[f,"UC"+V]],[/\bqbcore\/([\w\.]+)/i],[b,[f,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[b,[f,"WeChat"]],[/konqueror\/([\w\.]+)/i],[b,[f,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[b,[f,"IE"]],[/yabrowser\/([\w\.]+)/i],[b,[f,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[f,/(.+)/,"$1 Secure "+V],b],[/\bfocus\/([\w\.]+)/i],[b,[f,W+" Focus"]],[/\bopt\/([\w\.]+)/i],[b,[f,Pe+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[b,[f,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[b,[f,"Dolphin"]],[/coast\/([\w\.]+)/i],[b,[f,Pe+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[b,[f,"MIUI "+V]],[/fxios\/([-\w\.]+)/i],[b,[f,W]],[/\bqihu|(qi?ho?o?|360)browser/i],[[f,"360 "+V]],[/(oculus|samsung|sailfish)browser\/([\w\.]+)/i],[[f,/(.+)/,"$1 "+V],b],[/(comodo_dragon)\/([\w\.]+)/i],[[f,/_/g," "],b],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[f,b],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i],[f],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[f,wn],b],[/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[f,b],[/\bgsa\/([\w\.]+) .*safari\//i],[b,[f,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[b,[f,N+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[f,N+" WebView"],b],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[b,[f,"Android "+V]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[f,b],[/version\/([\w\.]+) .*mobile\/\w+ (safari)/i],[b,[f,"Mobile Safari"]],[/version\/([\w\.]+) .*(mobile ?safari|safari)/i],[b,f],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[f,[b,vt,ks]],[/(webkit|khtml)\/([\w\.]+)/i],[f,b],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[f,"Netscape"],b],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[b,[f,W+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i],[f,b]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[A,"amd64"]],[/(ia32(?=;))/i],[[A,xe]],[/((?:i[346]|x)86)[;\)]/i],[[A,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[A,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[A,"armhf"]],[/windows (ce|mobile); ppc;/i],[[A,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[A,/ower/,i,xe]],[/(sun4\w)[;\)]/i],[[A,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[A,xe]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[pt]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[l,[w,pt],[u,y]],[/\b((?:s[cgp]h|gt|sm)-\w+|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[l,[w,pt],[u,g]],[/\((ip(?:hone|od)[\w ]*);/i],[l,[w,G],[u,g]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[l,[w,G],[u,y]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[l,[w,j],[u,y]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}-[atu]?[ln][01259x][012359][an]?)\b(?!.+d\/s)/i],[l,[w,j],[u,g]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[l,/_/g," "],[w,fn],[u,g]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[l,/_/g," "],[w,fn],[u,y]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[l,[w,"OPPO"],[u,g]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[l,[w,"Vivo"],[u,g]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[l,[w,"Realme"],[u,g]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[l,[w,dn],[u,g]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[l,[w,dn],[u,y]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[l,[w,z],[u,y]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[l,[w,z],[u,g]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[l,[w,"Lenovo"],[u,y]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[l,/_/g," "],[w,"Nokia"],[u,g]],[/(pixel c)\b/i],[l,[w,Y],[u,y]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[l,[w,Y],[u,g]],[/droid.+ ([c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[l,[w,mt],[u,g]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[l,"Xperia Tablet"],[w,mt],[u,y]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[l,[w,"OnePlus"],[u,g]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[l,[w,U],[u,y]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[l,/(.+)/g,"Fire Phone $1"],[w,U],[u,g]],[/(playbook);[-\w\),; ]+(rim)/i],[l,w,[u,y]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[l,[w,$],[u,g]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[l,[w,se],[u,y]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[l,[w,se],[u,g]],[/(nexus 9)/i],[l,[w,"HTC"],[u,y]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic|sony)[-_ ]?([-\w]*)/i],[w,[l,/_/g," "],[u,g]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[l,[w,"Acer"],[u,y]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[l,[w,"Meizu"],[u,g]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[l,[w,"Sharp"],[u,g]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[w,l,[u,g]],[/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[w,l,[u,y]],[/(surface duo)/i],[l,[w,wt],[u,y]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[l,[w,"Fairphone"],[u,g]],[/(u304aa)/i],[l,[w,"AT&T"],[u,g]],[/\bsie-(\w*)/i],[l,[w,"Siemens"],[u,g]],[/\b(rct\w+) b/i],[l,[w,"RCA"],[u,y]],[/\b(venue[\d ]{2,7}) b/i],[l,[w,"Dell"],[u,y]],[/\b(q(?:mv|ta)\w+) b/i],[l,[w,"Verizon"],[u,y]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[l,[w,"Barnes & Noble"],[u,y]],[/\b(tm\d{3}\w+) b/i],[l,[w,"NuVision"],[u,y]],[/\b(k88) b/i],[l,[w,"ZTE"],[u,y]],[/\b(nx\d{3}j) b/i],[l,[w,"ZTE"],[u,g]],[/\b(gen\d{3}) b.+49h/i],[l,[w,"Swiss"],[u,g]],[/\b(zur\d{3}) b/i],[l,[w,"Swiss"],[u,y]],[/\b((zeki)?tb.*\b) b/i],[l,[w,"Zeki"],[u,y]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[w,"Dragon Touch"],l,[u,y]],[/\b(ns-?\w{0,9}) b/i],[l,[w,"Insignia"],[u,y]],[/\b((nxa|next)-?\w{0,9}) b/i],[l,[w,"NextBook"],[u,y]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[w,"Voice"],l,[u,g]],[/\b(lvtel\-)?(v1[12]) b/i],[[w,"LvTel"],l,[u,g]],[/\b(ph-1) /i],[l,[w,"Essential"],[u,g]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[l,[w,"Envizen"],[u,y]],[/\b(trio[-\w\. ]+) b/i],[l,[w,"MachSpeed"],[u,y]],[/\btu_(1491) b/i],[l,[w,"Rotor"],[u,y]],[/(shield[\w ]+) b/i],[l,[w,"Nvidia"],[u,y]],[/(sprint) (\w+)/i],[w,l,[u,g]],[/(kin\.[onetw]{3})/i],[[l,/\./g," "],[w,wt],[u,g]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[l,[w,gt],[u,y]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[l,[w,gt],[u,g]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[w,l,[u,p]],[/droid.+; (shield) bui/i],[l,[w,"Nvidia"],[u,p]],[/(playstation [345portablevi]+)/i],[l,[w,mt],[u,p]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[l,[w,wt],[u,p]],[/smart-tv.+(samsung)/i],[w,[u,x]],[/hbbtv.+maple;(\d+)/i],[[l,/^/,"SmartTV"],[w,pt],[u,x]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[w,z],[u,x]],[/(apple) ?tv/i],[w,[l,G+" TV"],[u,x]],[/crkey/i],[[l,N+"cast"],[w,Y],[u,x]],[/droid.+aft(\w)( bui|\))/i],[l,[w,U],[u,x]],[/\(dtv[\);].+(aquos)/i],[l,[w,"Sharp"],[u,x]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w ]*; *(\w[^;]*);([^;]*)/i],[[w,bt],[l,bt],[u,x]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[u,x]],[/((pebble))app/i],[w,l,[u,T]],[/droid.+; (glass) \d/i],[l,[w,Y],[u,T]],[/droid.+; (wt63?0{2,3})\)/i],[l,[w,gt],[u,T]],[/(quest( 2)?)/i],[l,[w,wn],[u,T]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[w,[u,O]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[l,[u,g]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[l,[u,y]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[u,y]],[/(phone|mobile(?:[;\/]| safari)|pda(?=.+windows ce))/i],[[u,g]],[/(android[-\w\. ]{0,9});.+buil/i],[l,[w,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[b,[f,X+"HTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[b,[f,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[f,b],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[b,f]],os:[[/microsoft (windows) (vista|xp)/i],[f,b],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[f,[b,vt,mn]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[f,"Windows"],[b,vt,mn]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[b,/_/g,"."],[f,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[f,"Mac OS"],[b,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86)/i],[b,f],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[f,b],[/\(bb(10);/i],[b,[f,$]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[b,[f,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[b,[f,W+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[b,[f,"webOS"]],[/crkey\/([\d\.]+)/i],[b,[f,N+"cast"]],[/(cros) [\w]+ ([\w\.]+\w)/i],[[f,"Chromium OS"],b],[/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[f,b],[/(sunos) ?([\w\.\d]*)/i],[[f,"Solaris"],b],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[f,b]]},Q=function(C,k){if(typeof C===d&&(k=C,C=n),!(this instanceof Q))return new Q(C,k).getResult();var S=C||(typeof t!==c&&t.navigator&&t.navigator.userAgent?t.navigator.userAgent:i),I=k?Ts(gn,k):gn;return this.getBrowser=function(){var E={};return E[f]=n,E[b]=n,Ce.call(E,S,I.browser),E.major=As(E.version),E},this.getCPU=function(){var E={};return E[A]=n,Ce.call(E,S,I.cpu),E},this.getDevice=function(){var E={};return E[w]=n,E[l]=n,E[u]=n,Ce.call(E,S,I.device),E},this.getEngine=function(){var E={};return E[f]=n,E[b]=n,Ce.call(E,S,I.engine),E},this.getOS=function(){var E={};return E[f]=n,E[b]=n,Ce.call(E,S,I.os),E},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return S},this.setUA=function(E){return S=typeof E===h&&E.length>K?bt(E,K):E,this},this.setUA(S),this};Q.VERSION=s,Q.BROWSER=Me([f,b,m]),Q.CPU=Me([A]),Q.DEVICE=Me([l,w,u,p,g,x,y,T,O]),Q.ENGINE=Q.OS=Me([f,b]),r.exports&&(e=r.exports=Q),e.UAParser=Q;var we=typeof t!==c&&(t.jQuery||t.Zepto);if(we&&!we.ua){var Oe=new Q;we.ua=Oe.getResult(),we.ua.get=function(){return Oe.getUA()},we.ua.set=function(C){Oe.setUA(C);var k=Oe.getResult();for(var S in k)we.ua[S]=k[S]}}})(typeof window=="object"?window:ne)})(et,et.exports);const Ft=et.exports;Ft(navigator.userAgent);let ve;function tt(){if(ve!=null)return ve;try{new Response(new ReadableStream),ve=!0}catch(r){ve=!1}return ve}function ke(){return!(typeof TransformStream=="undefined"||!tt())}class ue{constructor(e,{method:t,headers:n,signal:s,body:i}){R(this,"url");R(this,"method");R(this,"headers");R(this,"body");R(this,"signal");this.url=e,this.method=t!=null?t:"GET",this.headers=new Headers(n),this.body=i!=null?i:null,this.signal=s!=null?s:new AbortController().signal}}class re{constructor(e,{status:t,statusText:n,headers:s,underlayer:i}){R(this,"status");R(this,"statusText");R(this,"headers");R(this,"body");R(this,"bodyReadResult");R(this,"underlayer");if(this.status=t!=null?t:200,this.statusText=n!=null?n:"",this.headers=Xn(s),this.underlayer=i,e==null||!ke())this.body=e,this.bodyReadResult=Promise.resolve({success:!0,size:0});else{const[o,a]=Yn(e);this.body=o,this.bodyReadResult=a}}}function De(r){const{status:e,statusText:t,headers:n,body:s}=r;return new re(s,{status:e,statusText:t,headers:n,underlayer:r})}class nt extends Error{constructor(t){super(`Unexpected HTTP status: ${t.status} ${t.statusText}`);R(this,"name","UnexpectedHttpStatusError");this.response=t}}const Jn=new Vn;let $t;typeof self!="undefined"&&($t=self,$t.addEventListener("message",r=>Jn.emit("message",r)));class er extends Error{constructor(){super(...arguments);R(this,"name","WindowClientError")}}class tr extends Error{constructor(){super(...arguments);R(this,"name","UnexpectedDataChannelCloseError")}}class nr extends Error{constructor(){super(...arguments);R(this,"name","UnexpectedDataChannel1stMessageError")}}function rt(r,e=()=>1){if(r.length===0)return null;const t=r.map(e),n=t.reduce((i,o)=>i+o,0);let s=Math.random()*n;for(let i=0;i<t.length;i++){const o=t[i];if(s<o)return r[i];s-=o}return r[0]}function ie(r){return r&&r.name==="AbortError"}const rr=new tr().name,sr=new nr().name;function Le(r){return!(r&&[rr,sr].includes(r.name)||ie(r)||r instanceof er)}class st extends Error{constructor(t){super(t+"");R(this,"name","ResolveError");this.cause=t}}class jt extends Error{constructor(){super(...arguments);R(this,"name","NoAvailableNodeError")}}class it extends Error{constructor(t){super(t+"");R(this,"name","DoWithNodeError");this.cause=t}}class oe extends Error{constructor(){super(...arguments);R(this,"name","LocalDNSError")}}function ir(r,e,t){const n=t||new URL(r).hostname;let s,i;r=r.replace(/^\w+:\/\//,"").split("#")[0];const o=r.indexOf("?");o>=0?(i=r.slice(o+1),r=r.slice(0,o)):i="";const a=r.indexOf("/");s=a>=0?r.slice(a):"",s=or(e.rewrites,s),i=ur(e.queryString,i);let c=n+s;return i!==""&&(c=c+"?"+i),c}function or(r,e){for(const t of r){const n=ar(t,e);if(n!=null){e=cr(t,n);break}}return e}function ar(r,e){return new RegExp(r.pattern).exec(e)}const lr=/\${(\d+)}/g;function cr(r,e){return r.repl.replace(lr,(t,n)=>{var i;const s=parseInt(n,10);return s>=e.length?t:(i=e[s])!=null?i:""})}function ur({type:r,values:e},t){if(r==="none")return"";if(r==="all")return t;const n=Sn(t),s=e!=null?e:[],i={};return Object.keys(n).forEach(o=>{r==="include"&&!s.includes(o)||r==="exclude"&&s.includes(o)||(i[o]=n[o])}),We(i)}function Vt(r,e){const t=new Map;return function(...s){const i=e(...s),o=t.get(i);if(o!=null)return o;const a=r(...s);return t.set(i,a),a.finally(()=>{t.delete(i)}),a}}const he=te("dns"),hr="miku-delivery/dns/cdn/v1",dr=[];function fr(){return It(dr)}const ot="result",wr={name:ot,indexes:[{name:"domain",keyPath:"domain"}]};class pr{constructor(e,t,n=Wn,s,i=2e3){R(this,"fingerprints",new Map);R(this,"storage",new Ht(hr,[wr]));R(this,"getResolveResultFromStorage",Vt(e=>this.storage.get(ot,e),e=>e));R(this,"refreshResolveResultInStorage",Vt((e,t)=>v(this,null,function*(){const n=yield this.dnsResolver(e,t,this.app,this.logger),s=Date.now()+n.ttl*1e3,i=F(_({},n),{domain:t,expireAt:s});return this.saveResolveResultToStorage(t,i),i}),(e,t)=>t));this.logger=e,this.app=t,this.dnsResolver=n,this.cacheKeyFn=s,this.resolveTimeout=i}getFingerprint(e){const t=this.fingerprints.get(e);if(t==null)throw new Error(`No fingerprint for ${e}`);return t}getCacheKey(e,t){return v(this,null,function*(){if(this.cacheKeyFn!=null)return this.cacheKeyFn(e);const n=yield this.resolveDomain(new ee,t);return Ge(n)?ir(e,n.cacheKey,n.bucket):e})}getMediaOptimization(e){return v(this,null,function*(){const t=yield this.resolveDomain(new ee,e);return Ge(t)?t.mediaOptimization:null})}saveResolveResultToStorage(e,t){return v(this,null,function*(){return this.storage.set(ot,e,t)})}resolveDomain(e,t){return v(this,null,function*(){const n=Date.now(),s=(()=>v(this,null,function*(){const i=yield this.getResolveResultFromStorage(t);return i==null?this.refreshResolveResultInStorage(e,t):(vr(i)&&(he("result from storage cache expired",t),this.refreshResolveResultInStorage(e,t)),e.set("dnsResolveFromCache",!0),i)}))().then(i=>(e.set("dnsResolveTotalTime",H(Date.now(),n)),i));return Promise.race([s,Tt(this.resolveTimeout,"Resolve domain")]).catch(i=>{throw console.warn("DNS resolve failed:",i),new st(i)})})}resolve(e,t){return v(this,null,function*(){let n=null;return yield this.do(e,t,1,s=>{n=s}),n})}do(e,t,n,s){return v(this,null,function*(){let i;he("Resolve for",t);const o=new URL(t).hostname,[a,c]=yield Promise.all([this.getCacheKey(t,o),this.resolveDomain(e,o)]);if(!Ge(c))throw new oe(`Non-ECDN resolve result: ${o}`);const{groups:d,rules:h}=c;if(d.length===0)throw new jt(`No available group for ${o}`);he("Resolved for",t);const m=Fn(h,a);if(m==null)throw new oe("No matched rule found");if(!$n(m))throw new oe("Do not serve with given rule");let l=m.groups.map(({groupidx:f,weight:u,splitn:w})=>{const b=d[f];if(b==null)throw new Error(`Unexpected groupidx: ${f}`);return{group:b,weight:u,splitn:w}});for(let f=0;f<n;f++){const u=rt(l,w=>w.weight);if(u==null)break;try{he("doWithGroup",f,a),yield gr(e,u.group,a,u.splitn,s);return}catch(w){if(console.warn("doWithGroup (weight:",u.weight,") failed:",w,a),i=w,ie(w))break;Le(w)&&(l=l.filter(b=>b!==u))}}throw i=ie(i)?i:new it(i),i})}}const Kt=new Map;function mr({elts:r}){const e=r.map(({id:s,replicas:i})=>`${s}:${i}`).join(","),t=Kt.get(e);if(t!=null)return t;const n=new me;return n.set(r.map(s=>({key:s.id,replicas:s.replicas}))),Kt.set(e,n),n}function gr(r,e,t,n,s){return v(this,null,function*(){const i=e.elts;if(i.length===0)throw new Error("Empty elt list");const o=mr(e),a=n===1?2:n;let c=o.getN(t,a).map(h=>i.find(m=>m.id===h)),d;for(let h=0;h<2;h++){const m=rt(c.slice(0,n),l=>l.replicas);if(m==null)break;try{he("doWithElt",m.id,t),r.set("downloadEltID",m.id),yield br(m,t,s);return}catch(l){if(console.warn("doWithElt",m.id,"failed:",l,t),d=l,ie(l))break;Le(l)&&(c=c.filter(f=>f!==m))}}throw d})}function br(r,e,t){return v(this,null,function*(){let n=r.addrs;if(n.length===0)throw new Error("Empty addr list");let s;for(let i=0;i<2;i++){const o=rt(n);if(o==null)break;try{he("do job with",o,e),yield t(o);return}catch(a){if(console.warn("do job with",o,"failed:",a,e),s=a,ie(a))break;Le(a)&&(n=n.filter(c=>c!==o))}}throw s})}function vr(r){return r.expireAt<Date.now()}class yr{constructor(){R(this,"front",null);R(this,"back",null)}insertElementBefore(e,t){const n=t.prev;n!=null?(n.next=e,e.prev=n):this.front=e,t.prev=e,e.next=t}insertElementAfter(e,t){const n=t.next;n!=null?(n.prev=e,e.next=n):this.back=e,t.next=e,e.prev=t}pushElementFront(e){const t=this.front;t!=null?(t.prev=e,e.next=t):this.back=e,this.front=e}pushElementBack(e){const t=this.back;t!=null?(t.next=e,e.prev=t):this.front=e,this.back=e}moveBefore(e,t){e!==t&&(this.remove(e),this.insertElementBefore(e,t))}moveAfter(e,t){e!==t&&(this.remove(e),this.insertElementAfter(e,t))}moveToFront(e){this.remove(e),this.pushElementFront(e)}moveToBack(e){this.remove(e),this.pushElementBack(e)}insertBefore(e,t){const n={value:e,prev:null,next:null};return this.insertElementBefore(n,t),n}insertAfter(e,t){const n={value:e,prev:null,next:null};return this.insertElementAfter(n,t),n}pushFront(e){const t={value:e,prev:null,next:null};return this.pushElementFront(t),t}pushBack(e){const t={value:e,prev:null,next:null};return this.pushElementBack(t),t}remove(e){const t=e.prev,n=e.next;return t!=null?(t.next=n,e.prev=null):this.front=n,n!=null?(n.prev=t,e.next=null):this.back=t,e.value}walk(e){let t=this.front;for(;t!=null;){if(e(t.value,t)===!1)return;t=t.next}}reverseWalk(e){let t=this.back;for(;t!=null;){if(e(t.value,t)===!1)return;t=t.prev}}}const at=te("dc/size-control");class Rr{constructor(e){R(this,"inited");R(this,"itemElementMap",new Map);R(this,"itemList",new yr);this.dc=e,this.inited=this.dc.walkItems((t,n)=>{const s={key:n,usedTime:t.usedTime,size:lt(t)},i=this.itemList.pushBack(s);this.itemElementMap.set(n,i)})}addItem(e,t){const n={key:e,usedTime:t.usedTime,size:lt(t)};let s=null;return this.itemList.reverseWalk((i,o)=>{if(i.usedTime<=t.usedTime)return s=this.itemList.insertAfter(n,o),!1}),s==null&&(s=this.itemList.pushFront(n)),this.itemElementMap.set(e,s),s}removeItem(e){const t=this.itemElementMap.get(e);t!=null&&(this.itemElementMap.delete(e),this.itemList.remove(t))}onItemSet(e,t){return v(this,null,function*(){yield this.inited;let n=this.itemElementMap.get(e);if(n==null){this.addItem(e,t);return}n.value.size=lt(t),t.usedTime!==n.value.usedTime&&(n.value.usedTime=t.usedTime,this.itemList.moveToBack(n))})}getLeftSpace(){return v(this,null,function*(){if(typeof navigator.storage.estimate=="undefined")return null;const{quota:e,usage:t}=yield navigator.storage.estimate();return e!=null&&t!=null?e-t:null})}freeUpSpace(e){return v(this,null,function*(){yield this.inited;let t=0;const n=[];this.itemList.walk(({key:s,size:i})=>{if(i!==0&&(n.push(s),t+=i,t>=e))return!1}),at("to free up space, remove",n),yield Promise.all(n.map(s=>v(this,null,function*(){yield this.dc.removeItemWithContent(s),this.removeItem(s)})))})}beforeContentSet(e,t,n){return v(this,null,function*(){if(n==null)return;yield this.inited;const s=yield this.getLeftSpace();if(s!=null&&s<n){const i=n-s;at("freeUpSpace for",e,t,i),yield this.freeUpSpace(i)}})}onQuotaExceeded(e,t,n){return v(this,null,function*(){at("quota exceeded",e,t,n),n!=null&&(yield this.freeUpSpace(n))})}}function xr([r,e],t){return e=e!=null?e:t,e!=null?e-r:0}function lt(r){return r.pieces.reduce((e,t)=>{var n,s;return e+xr(t,(s=(n=r.meta)==null?void 0:n.fsize)!=null?s:null)},0)}const Cr=te("dc"),Sr="miku-delivery/dc/v1",Gt=["miku/dc","miku/dc/v2","miku/dc/v3"];function Er(){return Promise.all([_r(Gt),It(Gt)])}function _r(r){return v(this,null,function*(){const t=(yield caches.keys()).filter(n=>r.includes(n));yield Promise.all(t.map(n=>caches.delete(n)))})}const ye="item",Xt="usedTimeIndex",Tr={name:ye,indexes:[{name:Xt,keyPath:"usedTime"}]};class Ar{constructor(e={},t=Sr){R(this,"db");R(this,"cr");R(this,"browserCache",null);R(this,"browserCachePromise",null);this.config=e,this.ns=t,this.db=new Ht(this.ns,[Tr]),this.cr=new Rr(this)}openBrowserCache(){return v(this,null,function*(){return this.browserCachePromise!=null?this.browserCachePromise:(this.browserCachePromise=caches.open(this.ns).catch(e=>{throw new de(e)}),this.browserCachePromise.then(e=>{this.browserCache=e}),this.browserCachePromise)})}getItem(e){return v(this,null,function*(){return this.db.get(ye,e)})}setItem(e,t){return v(this,null,function*(){Cr("setItem",e,t),yield this.db.set(ye,e,t),yield this.cr.onItemSet(e,t)})}walkItems(e){return v(this,null,function*(){return this.db.walkBy(ye,Xt,e)})}removeItemWithContent(e){return v(this,null,function*(){const t=yield this.getItem(e);t!=null&&(yield Promise.all(t.pieces.map(n=>this.removeContent(e,n))),yield this.db.remove(ye,e))})}browserCacheMatch(e){return v(this,null,function*(){let t=this.browserCache;return t==null&&(t=yield this.openBrowserCache()),t.match(e).catch(n=>{throw new de(n)})})}browserCachePut(e,t){return v(this,null,function*(){let n=this.browserCache;n==null&&(n=yield this.openBrowserCache()),yield n.put(e,t).catch(s=>{throw new de(s)})})}browserCacheDelete(e){return v(this,null,function*(){let t=this.browserCache;t==null&&(t=yield this.openBrowserCache()),yield t.delete(e).catch(n=>{throw new de(n)})})}getContent(e,t){return v(this,null,function*(){const n=yield this.browserCacheMatch(ct(e,t));if(n==null)return;if(n.body==null)throw new Error("Body expected for cached response");return De(n)})}setContent(e,t,n){return v(this,null,function*(){const s=ct(e,t),i=ce(n.headers);yield this.cr.beforeContentSet(e,t,i);let o;if(!tt())o=n.underlayer;else{const{headers:a,body:c}=n;o=new Response(c,{status:200,statusText:"OK",headers:a})}try{yield this.browserCachePut(s,o)}catch(a){throw a instanceof de&&a.cause instanceof Error&&a.cause.name==="QuotaExceededError"&&this.cr.onQuotaExceeded(e,t,i),a}})}removeContent(e,t){return v(this,null,function*(){const n=ct(e,t);return this.browserCacheDelete(n)})}dispose(){this.db.dispose()}}function ct(r,e){var t;return/^https?:\/\//.test(r)||(r="https://miku-cache.com/"+r),`${r}_with_range_${e[0]}_${(t=e[1])!=null?t:""}`}class de extends Error{constructor(t){super(t+"");R(this,"name","BrowserCacheError");this.cause=t}}class kr{constructor(e){this.logger=e}log(e){return this.logger.log("DoLog",e)}}const Qt="0.11.0",Dr=3,Yt=te("http");class Zt{constructor(e,t,n,s=0){R(this,"doLogger");this.client=t,this.resolver=n,this.clientResponseTimeout=s,this.doLogger=new kr(e)}doWithResolved(e,t,n){return v(this,null,function*(){Yt("fetch",t.url,"with resolved",n);const s=new AbortController;Tn(s,t.signal);const i=new ue(t.url,F(_({},t),{signal:s.signal}));i.headers.set("X-Miku-Agent",`miku-delivery-web/v${Qt}`);let o=this.client.fetch(e,i,n);this.clientResponseTimeout>0&&(o=Promise.race([o,Tt(this.clientResponseTimeout,"HTTPClient get response")]),o.catch(c=>{c instanceof _t&&s.abort(c)}));const a=yield o;if(Yt("fetch",t.url,"succeeded with status",a.status),a.status===429||a.status>=500)throw new nt(a);return a})}originalDo(e,t){return v(this,null,function*(){if(t.signal.aborted)throw t.signal.reason;let n=-1,s;if(yield this.resolver.do(e,t.url,Dr,i=>v(this,null,function*(){const o=new ee(e);n++,o.set("downloadRetryCount",n),s=yield this.doWithResolved(o,t,i)})),s==null)throw new Error(`Http do failed: resolver do finished with no finalResp, url: ${t.url}`);return s})}do(e,t){return v(this,null,function*(){const n=Date.now(),s=Fe();e.set("doID",s);let i,o=null;try{return i=yield this.originalDo(e,t),i}catch(a){throw o=a,a}finally{const{onDoError:a,onDoResponsed:c}=this.getDoLog(e,s,n);i==null?a(o):c(i.status)}})}getDoLog(e,t,n){const s=a=>{var c;return this.doLogger.log(_({lookup_type:!0,t_lookup:(c=e.get("dnsResolveFromCache")===!0?0:e.get("dnsResolveTotalTime"))!=null?c:-1,t_total:-1,ts_st:n,err_desc:"",err_msg:"",status_code:-1,task_id:e.get("taskID"),id:t},a))};return{onDoError:a=>{const c=Date.now();s(_({t_total:H(c,n)},le(a)))},onDoResponsed:a=>{const c=Date.now();s({t_total:H(c,n),status_code:a})}}}}class Lr{constructor(e){this.logger=e}log(e){return this.logger.log("TaskLog",e)}}class Jt{constructor(e,t,n,s){R(this,"id",Fe());R(this,"priority",0);R(this,"signal");R(this,"started",!1);R(this,"taskLogger");this.url=e,this.range=t,this.startByClient=s,this.taskLogger=new Lr(n)}setPriority(e){this.priority=e}start(e){return v(this,null,function*(){if(this.started)throw new Error("Task already started");if(this.started=!0,this.signal=e,e&&e.aborted)throw e.reason;const t=Date.now(),n=new ee;n.set("taskID",this.id),n.set("taskDomain",new URL(this.url).hostname);let s,i=null;try{return s=yield this.startByClient(n,this),s}catch(o){throw i=o,o}finally{const{logOnError:o,logOnTransfered:a}=this.log(n,t);s==null?o(i):s.underlayer.bodyReadResult.then(c=>{c.success?a():o(c.error)})}})}log(e,t){const n=e.get("taskCacheMatchAt"),s=e.get("task1stHttpDoAt"),i=e.get("taskResultStreamAt"),o=Date.now(),a=h=>{var m,l,f,u,w;return this.taskLogger.log(_({type:(m=e.get("taskType"))!=null?m:1,id:this.id,url:this.url,err_msg:"",err_desc:"",range_st:(f=(l=this.range)==null?void 0:l.start)!=null?f:-1,range_end:(w=(u=this.range)==null?void 0:u.end)!=null?w:-1,ts_st:t,t_cc_match:H(n,t),t_http_do:H(s,n),t_res_stream:H(i,n),t_res:H(o,i),t_trans:-1,t_total:-1},h))};return{logOnError:h=>{const m=Date.now();a(_({t_total:H(m,t)},le(h)))},logOnTransfered:()=>{const h=Date.now();a({t_trans:H(h,o),t_total:H(h,t)})}}}}class en{constructor(e,t,n,s,i){this.stream=e,this.size=t,this.fileSize=n,this.contentType=s,this.underlayer=i}blob(){return v(this,null,function*(){const t=this.stream.getReader(),n=[];for(;;){const{done:s,value:i}=yield t.read();if(s)break;const o=i;n.push(o)}return new Blob(n)})}}function ut(r,e,t){return r!=null&&t!=null&&t>=r&&(t=null),(e==null||e<0)&&(e=0),[e,t]}function tn(r,e){var s;const t=((s=e[0])!=null?s:0)===0,n=e[1]==null||r!=null&&e[1]===r;return t&&n}function Br(r,e){var s,i;const t=(s=e[0])!=null?s:0,n=(i=e[1])!=null?i:r;return n==null?null:n-t}function Pr(r,e,t){var c,d;if(e===0)return[];const n=(h,m)=>Ir(h,m,e!=null?e:Number.POSITIVE_INFINITY),s=(c=r==null?void 0:r[0])!=null?c:0,i=(d=r==null?void 0:r[1])!=null?d:e,o=[];let a=s;for(const h of t){if(a==null||e!=null&&h[1]!=null&&h[1]>e)break;if(!(h[1]!=null&&a>=h[1])){if(i==null||i>h[0]){h[0]>a&&o.push({cached:!1,range:ut(e,a,h[0])});const m=n(h[0],a)?h[0]:a,l=n(h[1],i)?i:h[1];n(l,m)&&(o.push({cached:!0,range:ut(e,m,l)}),a=l);continue}break}}return n(i,a)&&o.push({cached:!1,range:ut(e,a,i)}),o}function Mr(r,e){var s;const t=(s=e[0])!=null?s:0,n=e[1];for(const i of r){if(i[1]!=null&&i[1]<=t)continue;if(i[0]>t)break;const o=t-i[0],a=Hr(n!=null?n:i[1],i[0]);return{piece:i,start:o,end:a}}throw new Error("Piece not found")}function Or(r,e){return r.some(t=>t[0]===e[0]&&t[1]===e[1])?r:[...r,e].sort((t,n)=>t[0]-n[0])}function Ir(r,e,t){const n=r!=null?r:t,s=e!=null?e:t;return n>s}function Hr(r,e){return r==null||e==null?null:r-e}function nn(r){const e={},t=r.split(",").map(n=>{let[s,i]=n.split("=").map(o=>o.trim());return[s.toLowerCase(),i]});for(const[n,s]of t)if(n==="max-age"){if(s!=null){const i=parseInt(s,10);Number.isNaN(i)||(e["max-age"]=i)}}else(n==="no-cache"||n==="no-store")&&(e[n]=!0);return e}function Be(r){return Math.floor(r/1e3)}function rn(r,e){const t=r.get("Date");if(t==null)return e;const n=Date.parse(t);return Number.isNaN(n)?e:n}function zr(r,e,t){if(r!=null)return r;const n=e.get("Expires");if(n!=null){let s=Date.parse(n);Number.isNaN(s)&&(s=0);const i=rn(e,t);return Be(s-i)}return 3600}function Nr(r){const e=r.get("Age");if(e==null)return 0;const t=parseInt(e,10);return Number.isNaN(t)?0:t}function Ur(r,e,t,n){const s=Nr(r),i=rn(r,t),o=Math.max(0,Be(t-i)),a=Be(t-e),c=s+a,d=Math.max(o,c),h=Be(n-t);return d+h}function qr(r,e,t,n,s){var c;const i=(c=r==null?void 0:r["max-age"])!=null?c:null,o=zr(i,e,n),a=Ur(e,t,n,s);return o>a}function Wr(r,e,t,n){const s=r.get("Cache-Control"),i=s!=null?nn(s):null;return(i==null?void 0:i["no-cache"])===!0?!0:!qr(i,r,e,t,n)}function Fr(r){const e=r.get("Cache-Control"),t=e!=null?nn(e):null;return!(t!=null&&t["no-store"]===!0)}function $r(r){const e=r.get("ETag");return e==null?null:e.startsWith("W/")?e.slice(2):e}function jr(r,e){const t=new Headers(r),n=$r(e);n!=null&&t.set("If-None-Match",n);const s=e.get("Last-Modified");return s!=null&&t.set("If-Modified-Since",s),t}function Vr(r,e){return!(r.get("Last-Modified")===e.get("Last-Modified")&&r.get("ETag")===e.get("ETag"))}function Kr(r,e){const t=new Headers(r);return e.forEach((n,s)=>{s=s.toLowerCase(),!(s==="content-length"||s==="content-encoding"||s==="content-range")&&t.set(s,n)}),t}const Gr={threshold:0,contentRangeExposed:!0},M=te("ftask");class Xr{constructor(e,t,n,s,i,o,a){R(this,"id",Fe());R(this,"inited");R(this,"meta",null);R(this,"cachePieces",[]);R(this,"usedTime",0);this.cache=e,this.nativeHttpClient=t,this.http=n,this.key=s,this.url=i,this.patterns=o,this.getMediaOptimization=a,this.inited=this.resume()}fileSize(){var e,t;return(t=(e=this.meta)==null?void 0:e.fsize)!=null?t:null}cacheValidationRequired(){if(this.meta==null)return!1;const{requestTime:e,responseTime:t,headers:n}=this.meta;return e==null||t==null||n==null?!1:Wr(n,e,t,Date.now())}startTask(e,t){return v(this,null,function*(){var a,c;M("startTask",t.url);let n;const s=t.range!=null?[t.range.start,t.range.end]:[0,null];if(yield this.inited,this.usedTime=Date.now(),this.save(),ke())n=yield this.readRangeByPieces(e,t,s);else{M("supportStreamOperation: false",t.url,t.id);const d=[(a=s[0])!=null?a:0,s[1]],h=(c=yield this.cache.getContent(this.key,d))!=null?c:null;if(e.set("taskCacheMatchAt",Date.now()),h!=null&&!this.cacheValidationRequired())M("use cache",t.url,t.id),n=h;else if(M("doRequestAndSaveCache",t.url,t.id,h!=null),n=yield this.doRequestAndSaveCache(e,t,s,h!=null),n.status===304){if(h==null)throw new Error("Unexpected 304 with no cached response");n=h}e.set("taskResultStreamAt",Date.now())}const i=this.meta;if(i==null)throw new Error("Missing meta in fileTask");M("startTask resolved",t.url,t.id);const o=Br(i.fsize,s);return new en(n.body,o,i.fsize,i.headers.get("Content-Type"),n)})}readRangeByPieces(e,t,n){return v(this,null,function*(){const s=this.cacheValidationRequired();M("cacheValidationRequired",s);const i=Pr(n,this.fileSize(),this.cachePieces);if(M("applyRange",n,this.fileSize(),this.cachePieces,i),s){const c=i.some(h=>h.cached),d=yield this.doRequestAndSaveCache(e,t,n,c);if(d.status===200||d.status===206)return d}e.set("taskCacheMatchAt",Date.now());const o=new TransformStream(void 0),a=yield new Promise((c,d)=>v(this,null,function*(){try{for(let h=0;h<i.length;h++){const{cached:m,range:l}=i[h];let f=null;m&&(f=yield this.readPieceFromLocal(e,t,l)),f==null&&(f=yield this.readPieceFromRemote(e,t,l)),h===0&&c(f);const w=h===i.length-1;yield f.body.pipeTo(o.writable,{preventClose:!w})}}catch(h){h!=null&&console.warn("readRange stream error for",this.url,h),o.writable.abort(h),d(h)}}));return e.set("taskResultStreamAt",Date.now()),new re(o.readable,a)})}readPieceFromLocal(e,t,n){return v(this,null,function*(){M("readPieceFromLocal",t.url,n);const{piece:s,start:i,end:o}=Mr(this.cachePieces,n),a=yield this.cache.getContent(this.key,s);return a==null?(console.warn(`Missing cache item: ${this.key} [${s})`),null):new re(Je(a.body,[i,o]),a)})}readPieceFromRemote(e,t,n){return v(this,null,function*(){M("readPieceFromRemote",t.url,n);const s=yield this.doRequestAndSaveCache(e,t,n,!1);return!tn(this.fileSize(),n)&&s.status===200?(console.warn("Range request not supported for",this.url),new re(Je(s.body,n),s)):s})}doRequest(e,t,n,s){return v(this,null,function*(){var u;e.get("task1stHttpDoAt")==null&&e.set("task1stHttpDoAt",Date.now());const i=new ee(e);i.set("downloadFileTaskID",this.id);let o=new Headers({"Accept-Encoding":"identity;q=1, *;q=0"});n!=null&&(t.range==null&&tn(this.fileSize(),n)||o.set("Range",be({start:n[0],end:n[1]==null?null:n[1]-1})));const a=(u=this.meta)==null?void 0:u.headers;s&&a!=null&&(o=jr(o,a));const c=yield this.getMediaOptimization(),d=new ue(t.url,{method:"GET",headers:o,signal:t.signal}),h=Date.now();let m;!ke()||c.threshold<=0?m=yield this.http.do(i,d):m=yield Qr((...w)=>this.http.do(...w),(...w)=>this.nativeHttpClient.fetch(...w),c,this.patterns)(i,d);const l=Date.now();if(m.body==null)throw new Error("Body expected");let f=m.headers;if(s&&a!=null&&m.status===304)M(`updateStoredHeaders for ${this.url}`),f=Kr(a,m.headers);else if(m.status!==200&&m.status!==206)throw new nt(m);return yield this.onResponse(f,h,l),m.bodyReadResult.then(w=>{M(`bodyReadResult for ${this.url}:`,w)}),m})}doRequestAndSaveCache(e,t,n,s){return v(this,null,function*(){const i=yield this.doRequest(e,t,n,s);return(i.status===200||i.status===206)&&Fr(i.headers)?this.saveCachePiece(t,n,i):i})}saveCachePiece(e,t,n){return v(this,null,function*(){var o,a;let s=n,i;if(ke()){const{main:c,minor:d}=Zn(n.body);s=new re(c,n),i=new re(d,n)}else if(!e.range){const c=n.underlayer.clone();i=De(c)}if(i!=null){const c=[(o=t==null?void 0:t[0])!=null?o:0,(a=t==null?void 0:t[1])!=null?a:null];M("saveCachePiece",this.url,c),this.cache.setContent(this.key,c,i).then(()=>(this.cachePieces=Or(this.cachePieces,c),this.save())).then(()=>M("saveCachePiece finish",this.url,c),d=>M("saveCachePiece failed",this.url,d))}return s})}onResponse(e,t,n){return v(this,null,function*(){const s=this.meta;this.meta={fsize:Wt(e),requestTime:t,responseTime:n,headers:e},(s==null?void 0:s.headers)!=null&&Vr(s.headers,e)&&(M(`${this.url} modified, clear local cache`),yield Promise.all(this.cachePieces.map(i=>this.cache.removeContent(this.key,i))),this.cachePieces=[]),this.save()})}resume(){return v(this,null,function*(){const e=yield this.cache.getItem(this.key);e==null||e.meta==null||(this.meta=F(_({},e.meta),{headers:e.meta.headers!=null?new Headers(e.meta.headers):null}),this.cachePieces=e.pieces)})}save(){return v(this,null,function*(){var s,i;const e=((s=this.meta)==null?void 0:s.headers)!=null?[...((i=this.meta)==null?void 0:i.headers).entries()]:null,n={meta:this.meta!=null?F(_({},this.meta),{headers:e}):null,pieces:this.cachePieces,usedTime:this.usedTime};yield this.cache.setItem(this.key,n)})}}function Qr(r,e,{threshold:t,contentRangeExposed:n},s){return function(o,a){return v(this,null,function*(){var G,se;const U=a,{url:c}=U,d=Rt(U,["url"]),h=Ee(c);if(a.method!=="GET"||!s.media.some($=>$.test(h)))return r(o,a);const m=Ze(a.headers);M("doWithInitialOptimization",c);const l=new ee(o),f=new Headers(d.headers),u=_({start:null,end:null},m);u.start=(G=u.start)!=null?G:0;const w=u.start+t-1;(u.end==null||u.end>w)&&(u.end=w),f.set("Range",be(u));const b=new ue(c,F(_({},d),{headers:f})),p=yield(($,V)=>v(this,null,function*(){var Y;let N=null;const X=Ze(V.headers);X!=null&&!Nt(X)&&!n&&(N=Yr(c,d.headers,e));const W=yield e($,V);if(X!=null&&W.status===206&&!W.headers.get("Content-Range")){const j=Nt(X)?ce(W.headers):yield N;if(j!=null){const z=zt({start:X.start,end:(Y=X.end)!=null?Y:j-1,totalSize:j});W.headers.set("Content-Range",z)}}return W}))(l,b);if(p.body==null)throw new Error("Body expected for initial response");if(p.status!==206)return p;const g=Qe(p.headers);if(g==null)throw new Error("Header Content-Range expected for 206 response");const y=(()=>{var Y;const $=ce(p.headers);if($!=null&&$<t)return p.body;const V=new Headers(d.headers),N=_({start:null,end:null},m);if(N.start=((Y=N.start)!=null?Y:0)+t,N.end!=null&&N.end<N.start)return p.body;M("doWithInitialOptimization followingRange",N),V.set("Range",be(N));const X=new ue(c,F(_({},d),{headers:V})),W=new TransformStream;return p.body.pipeTo(W.writable,{preventClose:!0}).then(()=>v(this,null,function*(){M("doWithInitialOptimization initialBody transfered");let j;try{const z=yield r(o,X);if(z.body==null)throw new Error(`Body expected for following response of ${c}`);if(z.status===200)j=Je(z.body,[N.start,N.end==null?null:N.end+1]);else if(z.status===206)j=z.body;else throw new nt(z)}catch(z){if(Zr(z))M("use fallback fetch for doWithInitialOptimization followingBody",z),j=(yield e(o,X)).body;else{M("doWithInitialOptimization get followingBody failed",z),W.writable.abort(z);return}}j.pipeTo(W.writable).then(()=>M("doWithInitialOptimization followingBody transfered"),z=>M("doWithInitialOptimization followingBody transfer failed",z))}),j=>v(this,null,function*(){M("doWithInitialOptimization initialBody transfer failed",j)})),W.readable})(),x=g.totalSize,T=new Headers(p.headers);if(T.delete("Content-Range"),T.delete("Content-Length"),m==null)return x!=null&&T.set("Content-Length",x+""),new re(y,{status:200,statusText:"OK",headers:T,underlayer:p.underlayer});const O=(se=m.start)!=null?se:0,K=m.end!=null?m.end:x!=null?x-1:null;return K!=null&&T.set("Content-Length",K-O+1+""),T.set("Content-Range",zt({start:O,end:K,totalSize:x})),new re(y,{status:206,statusText:"Partial Content",headers:T,underlayer:p.underlayer})})}}function Yr(r,e,t){return v(this,null,function*(){const n=new Headers(e);n.delete("Range");const s=yield t(new ee,new ue(r,{method:"HEAD",headers:n}));return ce(s.headers)})}function Zr(r){return[st,oe,jt,it,ge,de].some(e=>r instanceof e)}class Jr{constructor(){R(this,"locked",!1);R(this,"waitings",[]);this.unlock=this.unlock.bind(this)}lock(){return v(this,null,function*(){return this.locked?(yield new Promise(e=>{this.waitings.push(e)}),this.unlock):(this.locked=!0,this.unlock)})}unlock(){if(this.waitings.length===0){this.locked=!1;return}this.waitings.shift()()}runExclusive(e){return v(this,null,function*(){const t=yield this.lock();try{return yield e()}catch(n){throw n}finally{t()}})}}function es(){var s,i;const{os:r,device:e,browser:t}=Ft(navigator.userAgent);let n;return typeof window!="undefined"?n=window.location:typeof self!==void 0&&(n=self.location),{os:`${r.name}_${r.version}`,browser:`${t.name}_${t.version}`,app:(s=n==null?void 0:n.host)!=null?s:"",sdk:`Web SDK v${Qt}`,dev_model:(i=e.model)!=null?i:"",dev_id:""}}const ht=200,dt=te("log");class ts{constructor(e,t,n,s,i){R(this,"env",We(es()));R(this,"flushMutex",new Jr);R(this,"buffer",[]);this.schemaName=e,this.fetch=t,this.flushNum=n,this.flushWait=s,this.app=i}callApiLog(e){return v(this,null,function*(){const t=this.fetch;try{const n=Ke({appID:this.app.appID,appSalt:this.app.appSalt,path:`${Et}/v1/log/${this.schemaName}`}),s=yield t(new Request(`${Et}/v1/log/${this.schemaName}`,{method:"POST",headers:{Authorization:n,"Content-Type":"text/csv","X-Env":this.env},body:rs(e)}));if(!s.ok)throw new Error(`Unexpected response status: ${s.status} ${s.statusText}`)}catch(n){console.warn("Call log API failed:",n)}})}flush(){return v(this,null,function*(){return this.flushMutex.runExclusive(()=>v(this,null,function*(){const e=this.buffer.splice(0);if(e.length===0)return;const t=Math.ceil(e.length/ht);return Promise.all(Array.from({length:t}).map((n,s)=>this.callApiLog(e.slice(s*ht,(s+1)*ht))))}))})}tryFlush(){return v(this,null,function*(){const e=yield this.flushMutex.runExclusive(()=>{const t=this.buffer;if(t.length===0)return!1;if(t.length>=this.flushNum)return dt("buffer.length >= this.flushNum"),!0;const n=Date.now()-t[0].ts;return n>=this.flushWait*1e3?(dt("waited >= this.flushWait"),!0):this.flushWait*1e3-n});if(e===!0)return this.flush();typeof e=="number"&&setTimeout(()=>this.tryFlush(),e)})}log(e){this.buffer.push(_({ts:Date.now()},e)),this.tryFlush()}}class ns{constructor(e,t=self.fetch,n=100,s=3){R(this,"schemaLoggers",new Map);this.appInfo=e,this.fetch=t,this.flushNum=n,this.flushWait=s}log(e,t){dt("log",e,t);let n=this.schemaLoggers.get(e);n==null&&(n=new ts(e,this.fetch,this.flushNum,this.flushWait,this.appInfo),this.schemaLoggers.set(e,n)),n.log(t)}}function rs(r){const e=Object.keys(r[0]),t=["ts",...e.filter(i=>i!=="ts")],n=t.map(sn).join(","),s=r.map(i=>t.map(o=>i[o]).map(o=>o!=null?o+"":"").map(sn).join(","));return[n,...s].join(`
`)}function sn(r){let e=r.replace(/"/g,'""');return/("|,|\n)/.test(e)&&(e='"'+e+'"'),e}class ss{constructor(e){this.logger=e}log(e){return this.logger.log("LiveScheduleLog",e)}}const is=new URL(qe).hostname;function os(r,e,t,n){return v(this,null,function*(){var l,f;const s=new ss(n),i={url:e,cip:""},o=Ke(F(_({},t),{path:qe})),a=Date.now();let c,d=null,h=null,m=null;try{if(d=yield fetch(qe,{method:"POST",body:JSON.stringify(i),headers:{"Content-Type":"application/json",Authorization:o}}),h=Date.now(),!d.ok)throw new Error(`Call Schedule API failed, status: ${d.status} ${d.statusText}`);return m=yield d.json()}catch(u){throw c=u}finally{const u=H(Date.now(),a),w=m==null?le(c):{err_msg:"",err_desc:""};s.log(F(_({r_id:(l=d==null?void 0:d.headers.get("x-reqid"))!=null?l:"",ip:"",domain:is,status_code:(f=d==null?void 0:d.status)!=null?f:-1},w),{t_conn:H(h,a),t_total:u,type:1}))}})}const Re=te("dns"),as=60,ls=60*1e3;class cs{constructor(e,t,n=os,s=Ee){R(this,"scheduling",new Map);R(this,"cache",new Map);R(this,"m3u8SegmentCache",new Map);this.logger=e,this.app=t,this.scheduler=n,this.cacheUrl=s}getScheduleResult(e,t){return v(this,null,function*(){var o;const n=Date.now();let s;try{s=yield this.scheduler(e,t,this.app,this.logger)}catch(a){throw console.warn("Live schedule failed:",a),new st(a)}finally{e.set("dnsResolveTotalTime",H(Date.now(),n))}if(s.code===1)throw new oe(`Local DNS for ${t}`);if(s.code!==0)throw new Error(`Unexpected schedule code: ${s.code}`);const i=(o=s.ttl)!=null?o:as;return{nodes:s.hosts.map(a=>{const[c,d]=kn(a,0),[h,m]=["",0];return{addr:{ip:h,host:c,http:d+80,https:d+443,how:m},after:0}}),expireAt:Date.now()+i*1e3,ttl:i}})}saveM3u8SegmentResult(e,t){return v(this,null,function*(){const n=this.cacheUrl(e),s=this.cache.get(n);if(s==null){console.warn("No schedule result for m3u8:",e);return}const i=t.map(this.cacheUrl);i.forEach(o=>{this.m3u8SegmentCache.set(o,s)}),setTimeout(()=>{i.forEach(o=>{this.m3u8SegmentCache.delete(o)})},6e4)})}schedule(e,t){return v(this,null,function*(){const n=this.cacheUrl(t);if(!_e(t)&&!Dt(t)){const a=this.m3u8SegmentCache.get(n);if(a==null)throw new oe("Neither m3u8 / flv URL, or m3u8 segment URL");return a}const s=this.cache.get(n);if(s!=null&&ft(s))return e.set("dnsResolveFromCache",!0),s;const i=this.scheduling.get(n);if(i!=null){let a;try{a=yield i}catch(c){if(c instanceof oe)throw c}if(a!=null&&ft(a))return e.set("dnsResolveFromCache",!0),a;this.scheduling.delete(n)}const o=this.getScheduleResult(e,t);return Re("save scheduling for",t),this.scheduling.set(n,o),o.then(a=>{Re("save cache for",t),this.cache.set(n,a)},()=>{}),o})}hasResult(e){const t=this.cacheUrl(e),n=_e(e)||Dt(e)?this.cache.get(t):this.m3u8SegmentCache.get(t);return n!=null&&ft(n)}do(e,t,n,s){return v(this,null,function*(){let i;Re("schedule for",t);const o=yield this.schedule(e,t);Re("scheduled for",t);for(let a=0;a<n;a++){const c=us(o.nodes);if(c==null)break;try{Re("do job with",c,t),yield s(c.addr),o.expireAt=Date.now()+o.ttl*1e3;return}catch(d){if(console.warn("do job with",c.addr,"failed:",d,t),i=d,ie(d))break;Le(d)&&(c.after=Date.now()+ls)}}throw i=ie(i)?i:new it(i),i})}}function on(r,e=Date.now()){return r.after<e}function us(r){for(const e of r)if(on(e))return e;return null}function ft(r){const e=Date.now();return r.expireAt<=e?!1:r.nodes.some(t=>on(t,e))}const fe=te("utils/fetch");function an(r){return v(this,null,function*(){var f,u;const e=yield fetch(r),t=Ze(r.headers);if(t==null||e.status!==206||e.body==null)return e;const{body:n,status:s,statusText:i,headers:o}=e,a=(f=Qe(o))==null?void 0:f.end,c=100;let d=(u=t.start)!=null?u:0,h=n.getReader(),m=null;const l=new ReadableStream({pull:w=>v(this,null,function*(){m!=null&&(clearTimeout(m),m=null),h==null&&(fe("resume on pull"),r.headers.set("range",be(F(_({},t),{start:d}))),h=(yield fetch(r)).body.getReader());const{value:b,done:A}=yield h.read();if(A){fe("read done"),w.close();return}try{w.enqueue(b)}catch(p){fe("enqueue failed:",p),h==null||h.cancel("target stream enqueue failed");return}if(d+=b.byteLength,a!=null&&d>a){fe("all enqueued"),h.cancel("all enqueued"),w.close();return}m=setTimeout(()=>v(this,null,function*(){m=null,h!=null&&(fe("cancel after long time no pull"),h.cancel("long time no read"),h=null)}),c)}),cancel:w=>{fe("cancel",w),h==null||h.cancel(w)}});return new Response(l,{status:s,statusText:i,headers:o})})}class ln{constructor(e){this.logger=e}start(e,t){let n;const s=Date.now(),i=c=>{var m,l,f,u,w,b,A,p,g,y,x,T;const d=t.headers.get("Range"),h=d==null?null:Ut(d);this.log(_({ip:(m=e.get("downloadReqIP"))!=null?m:"",domain:(l=e.get("taskDomain"))!=null?l:"",range_st:(f=h==null?void 0:h.start)!=null?f:-1,range_end:(u=h==null?void 0:h.end)!=null?u:-1,retry:(w=e.get("downloadRetryCount"))!=null?w:0,ftask_id:(b=e.get("downloadFileTaskID"))!=null?b:"",task_id:(A=e.get("taskID"))!=null?A:"",d_id:(p=e.get("doID"))!=null?p:"",ts_st:s,r_id:(g=n==null?void 0:n.headers.get("x-reqid"))!=null?g:"",elt_id:(y=e.get("downloadEltID"))!=null?y:"",status_code:(x=n==null?void 0:n.status)!=null?x:-1,t_req_msg:H(e.get("downloadReqMessageAt"),s),t_conn:H(e.get("downloadConnectionAt"),(T=e.get("downloadReqMessageAt"))!=null?T:s),t_tls:-1,t_st_trans:H(e.get("downloadStartTransferAt"),e.get("downloadConnectionAt")),t_resp_msg:H(e.get("downloadRespMessageAt"),e.get("downloadStartTransferAt")),err_msg:"",err_desc:"",t_content_trans:-1,t_total:-1,resp_size:-1},c))};return{onError:c=>{const d=Date.now();i(_({t_total:H(d,s)},le(c)))},onResponse:c=>{n=c,n.bodyReadResult.then(d=>{var l;const h=Date.now(),m=d.success?null:le(d.error);i(_({t_content_trans:H(h,(l=e.get("downloadRespMessageAt"))!=null?l:e.get("downloadStartTransferAt")),t_total:H(h,s),resp_size:d.size},m))})}}}wrap(e,t,n){return v(this,null,function*(){const s=this.start(e,t);try{const i=yield n();return s.onResponse(i),i}catch(i){throw s.onError(i),i}})}log(e){return this.logger.log("DownloadLog",e)}}class hs{constructor(e){R(this,"downloadLogger");this.downloadLogger=new ln(e)}fetch(e,t,n=!0){return v(this,null,function*(){return this.downloadLogger.wrap(e,t,()=>v(this,null,function*(){const d=t,{url:s}=d,i=Rt(d,["url"]),o=new Request(s,_(_({},n?cn:null),i)),a=yield an(o),c=Date.now();return e.set("downloadConnectionAt",c),e.set("downloadStartTransferAt",c),De(a)}))})}}const cn={mode:"cors",credentials:"omit"};class un{constructor(e,t=!0,n=an){R(this,"downloadLogger");this.https=t,this.nativeFetch=n,this.downloadLogger=new ln(e)}fetch(e,t,n){return v(this,null,function*(){return this.downloadLogger.wrap(e,t,()=>v(this,null,function*(){e.set("downloadReqIP",n.host);const s=this.nativeFetch,i=ds(t,n,this.https),o=yield s(i),a=Date.now();return e.set("downloadConnectionAt",a),e.set("downloadStartTransferAt",a),De(o)}))})}dispose(){}}function ds(r,e,t=!0){const{url:n,headers:s,method:i,signal:o}=r,a=new URL(n),c=a.host,d=new Headers(s);a.protocol=t?"https:":"http:",a.host=`${e.host}:${t?e.https:e.http}`,a.pathname=`/${c}${a.pathname}`;let h=a.toString();if(d.has("X-Miku-Agent")){const m=d.get("X-Miku-Agent");d.delete("X-Miku-Agent");const l=h.includes("?")?"&":"?",f=["X-Miku-Agent",m].map(encodeURIComponent).join("=");h=h+l+f}return new Request(h,F(_({},cn),{headers:d,method:i,signal:o}))}function fs(r){const e=[],t=r.split(`
`).map(s=>s.trim()).filter(s=>s.length>0);if(t[0]!=="#EXTM3U")throw new Error("Invalid Extended M3U Playlist");let n=null;for(const s of t){if(s.startsWith("#")){s.startsWith("#EXTINF:")&&(n=s);continue}n!=null&&(e.push({uri:s}),n=null)}return e}const hn=te("client");class ws{constructor(e,t){R(this,"fileTasks",new Map);R(this,"cache");R(this,"cdnResolver");R(this,"liveResolver");R(this,"nativeHttpClient");R(this,"http");R(this,"liveHttp");R(this,"patterns");R(this,"logger");var o,a,c,d,h;this.config=t,t!=null&&t.debug&&St(),this.cache=new Ar(t==null?void 0:t.cache),this.logger=(o=t==null?void 0:t.logger)!=null?o:new ns(e),this.cdnResolver=(a=t==null?void 0:t.resolver)!=null?a:new pr(this.logger,e,t==null?void 0:t.dnsResolver,t==null?void 0:t.cacheUrl),this.liveResolver=(c=t==null?void 0:t.liveResolver)!=null?c:new cs(this.logger,e,t==null?void 0:t.scheduler),this.nativeHttpClient=new hs(this.logger);const n=(d=t==null?void 0:t.httpClient)!=null?d:new un(this.logger),s=(h=t==null?void 0:t.liveHttpClient)!=null?h:new un(this.logger);this.patterns=_(_({},At),t==null?void 0:t.patterns),this.http=new Zt(this.logger,n,this.cdnResolver,6e3);const i=2e3;this.liveHttp=new Zt(this.logger,s,this.liveResolver,i)}prepare(e){return v(this,null,function*(){return Promise.all(e.map(t=>this.cdnResolver.resolveDomain(new ee,t))).catch(t=>{console.warn("prepare failed:",t)})})}createTask(e,t){const n=e.indexOf("#");return n>=0&&(e=e.slice(0,n)),new Jt(e,t!=null?t:null,this.logger,(s,i)=>(s.set("taskType",1),this.startTask(s,i)))}createLiveTask(e,t){const n=e.indexOf("#");return n>=0&&(e=e.slice(0,n)),new Jt(e,t!=null?t:null,this.logger,(s,i)=>(s.set("taskType",2),this.startLiveTask(s,i)))}startTask(e,t){return v(this,null,function*(){const n=new URL(t.url).hostname,s=yield this.cdnResolver.getCacheKey(t.url,n);let i=this.fileTasks.get(s);if(i==null){const o=()=>v(this,null,function*(){var c;const a=yield this.cdnResolver.getMediaOptimization(n);return _(_(_({},Gr),a),(c=this.config)==null?void 0:c.mediaOptimization)});i=new Xr(this.cache,this.nativeHttpClient,this.http,s,t.url,this.patterns,o),this.fileTasks.set(s,i)}return i.startTask(e,t)})}saveM3u8SegmentResult(e,t){return v(this,null,function*(){const n=yield Qn(t),i=fs(n).map(o=>Dn(o.uri,e));hn("saveM3u8SegmentResult",Ee(e),i.map(Ee)),yield this.liveResolver.saveM3u8SegmentResult(e,i)})}startLiveTask(e,t){return v(this,null,function*(){var d,h;const n={};t.range!=null&&(n.Range=be({start:t.range.start,end:t.range.end==null?null:t.range.end-1}));const s=new ue(t.url,{method:"GET",headers:n,signal:t.signal});let i,a=((h=(d=this.config)==null?void 0:d.liveOptimization)!=null?h:!0)&&_e(t.url)&&!this.liveResolver.hasResult(t.url);if(a){hn("use nativeClient for",t.url);const m=this.nativeHttpClient.fetch(e,s);this.liveHttp.do(new ee(e),s).catch(l=>{console.warn("do failed when prefetch for liveOptimization:",l)}),i=yield m}else i=yield this.liveHttp.do(e,s);if(i.body==null)throw new Error("Body expected");if(i.status!==200&&i.status!==206)throw new Error(`Invalid response, status: ${i.status}`);let c=i.body;if(!a&&tt()&&_e(t.url)){const[m,l]=i.body.tee();this.saveM3u8SegmentResult(t.url,l).catch(f=>{console.warn("Save M3u8 segment cache failed:",t.url,f)}),c=m}return new en(c,ce(i.headers),Wt(i.headers),i.headers.get("Content-Type"),i)})}dispose(){this.cache.dispose()}}function ps(r){return r&&r.mikuDeliveryProxy===!0}const ms="MIKU_DELIVERY_PROXY_CONFIG";function gs(r,e){const t=s=>s==null?void 0:s.map(i=>({source:i.source,flags:i.flags})),n=F(_({},e),{patterns:e.patterns==null?void 0:_n(e.patterns,s=>t(s))});return En(r,{[ms]:JSON.stringify(n)})}function bs(r){return Array.isArray(r)?{cdn:r,live:[]}:_({cdn:[],live:[]},r)}function vs(r){const e={},t=[];for(const{url:n,ecdn:s,fallback:i}of r){const o=new URL(n),a=o.hostname,c=kt(o.pathname);if(a!=="localhost"&&a.indexOf(".")<0||/\.qnqcdn\.net$/.test(a))continue;let d=e[a];d==null&&(e[a]=d={exts:[],total:0,ecdn:0,fallback:0}),d.exts.includes(c)||d.exts.push(c),d.total++,s&&d.ecdn++,i&&d.fallback++,An(o,At)&&!t.includes(a)&&t.push(a)}return e}function ys(r,e){const t={};for(const{url:n,ecdn:s,size:i}of e){const o=new URL(n),a=o.hostname,c=kt(o.pathname);if(!(!r.includes(a)&&!r.includes("*")))for(const d of[`${a}/*`,`${a}/*.${c||"<none>"}`]){let h=t[d];h==null&&(t[d]=h={total:0,totalSize:0,ecdn:0,ecdnSize:0}),h.total++,h.totalSize+=i!=null?i:0,s&&(h.ecdn++,h.ecdnSize+=i!=null?i:0)}}return t}function Rs(r,e,t){return v(this,null,function*(){r=gs(r,e),yield navigator.serviceWorker.register(r,t)})}function xs(){return v(this,null,function*(){Cs()})}function Cs(){function r(e){var n;const t={mikuDeliveryProxy:!0,type:`window-${e}`};(n=navigator.serviceWorker.controller)==null||n.postMessage(t)}r("available"),window.addEventListener("pageshow",()=>r("available")),window.addEventListener("pagehide",()=>r("unavailable")),window.addEventListener("beforeunload",()=>r("unavailable"))}function Ss(r,e){navigator.serviceWorker.addEventListener("message",({data:t})=>{if(!ps(t)||t.type!=="window-fetch-items")return;const n=vs(t.items),s=bs(r.domains),i=ys([...s.cdn,...s.live],t.items);e(n,i)}),window.addEventListener("load",()=>{setTimeout(()=>{var n;const t={mikuDeliveryProxy:!0,type:"get-window-fetch-items"};(n=navigator.serviceWorker.controller)==null||n.postMessage(t)},1e3)})}function Es(r,e,t){return v(this,null,function*(){const n=_s();if(n!=null){console.warn("Ability not OK for Miku Delivery Proxy API:",n);return}e.debug&&St(),yield Promise.all([xs(),Rs(r,e,t),Er(),fr()])})}function _s(){return"serviceWorker"in navigator?null:"navigator.serviceWorker not available"}return D.Client=ws,D.initProxy=Es,D.listenStatistics=Ss,Object.defineProperties(D,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}}),D}({});
