var Cr=Object.defineProperty,xr=Object.defineProperties;var _r=Object.getOwnPropertyDescriptors;var Xe=Object.getOwnPropertySymbols;var An=Object.prototype.hasOwnProperty,kn=Object.prototype.propertyIsEnumerable;var Lt=(B,P,D)=>P in B?Cr(B,P,{enumerable:!0,configurable:!0,writable:!0,value:D}):B[P]=D,T=(B,P)=>{for(var D in P||(P={}))An.call(P,D)&&Lt(B,D,P[D]);if(Xe)for(var D of Xe(P))kn.call(P,D)&&Lt(B,D,P[D]);return B},$=(B,P)=>xr(B,_r(P));var Ie=(B,P)=>{var D={};for(var F in B)An.call(B,F)&&P.indexOf(F)<0&&(D[F]=B[F]);if(B!=null&&Xe)for(var F of Xe(B))P.indexOf(F)<0&&kn.call(B,F)&&(D[F]=B[F]);return D};var R=(B,P,D)=>(Lt(B,typeof P!="symbol"?P+"":P,D),D);var v=(B,P,D)=>new Promise((F,Le)=>{var Ye=V=>{try{pe(D.next(V))}catch(oe){Le(oe)}},Qe=V=>{try{pe(D.throw(V))}catch(oe){Le(oe)}},pe=V=>V.done?F(V.value):Promise.resolve(V.value).then(Ye,Qe);pe((D=D.apply(B,P)).next())});(function(){"use strict";function B(s){const e=[],t=s.length;for(let n=0;n<t;n++){let r=s.charCodeAt(n);if(r>=55296&&r<=56319&&t>n+1){const i=s.charCodeAt(n+1);i>=56320&&i<=57343&&(r=(r-55296)*1024+i-56320+65536,n+=1)}if(r<128){e.push(r);continue}if(r<2048){e.push(r>>6|192),e.push(r&63|128);continue}if(r<55296||r>=57344&&r<65536){e.push(r>>12|224),e.push(r>>6&63|128),e.push(r&63|128);continue}if(r>=65536&&r<=1114111){e.push(r>>18|240),e.push(r>>12&63|128),e.push(r>>6&63|128),e.push(r&63|128);continue}e.push(239,191,189)}return new Uint8Array(e).buffer}function P(s){return s^=s>>>16,s=Math.imul(s,2246822507),s^=s>>>13,s=Math.imul(s,3266489909),s^=s>>>16,s>>>0}const D=new Uint32Array([3432918353,461845907]);function F(s,e){return s<<e|s>>>32-e}function Le(s,e){const t=s.byteLength/4|0,n=new Uint32Array(s,0,t);for(let r=0;r<t;r++)n[r]=Math.imul(n[r],D[0]),n[r]=F(n[r],15),n[r]=Math.imul(n[r],D[1]),e[0]=e[0]^n[r],e[0]=F(e[0],13),e[0]=Math.imul(e[0],5)+3864292196}function Ye(s,e){const t=s.byteLength/4|0,n=s.byteLength%4;let r=0;const i=new Uint8Array(s,t*4,n);switch(n){case 3:r=r^i[2]<<16;case 2:r=r^i[1]<<8;case 1:r=r^i[0]<<0,r=Math.imul(r,D[0]),r=F(r,15),r=Math.imul(r,D[1]),e[0]=e[0]^r}}function Qe(s,e){e[0]=e[0]^s.byteLength,e[0]=P(e[0])}function pe(s,e){if(e=e?e|0:0,typeof s=="string"&&(s=B(s)),!(s instanceof ArrayBuffer))throw new TypeError("Expected key to be ArrayBuffer or string");const t=new Uint32Array([e]);return Le(s,t),Ye(s,t),Qe(s,t),t.buffer}class V{constructor(e=Dn){R(this,"circle",new Map);R(this,"members",new Set);R(this,"membersReplicas",new Map);R(this,"sortedHashes",[]);this.hasher=e}clone(){const e=new V;return e.circle=new Map(this.circle),e.members=new Set(this.members),e.membersReplicas=new Map(this.membersReplicas),e.sortedHashes=[...this.sortedHashes],e}updateSortedHashes(){this.sortedHashes=[...this.circle.keys()].sort((e,t)=>e-t)}_add({key:e,replicas:t}){for(let n=0;n<t;n++){const r=this.hasher(oe(e,n));this.circle.set(r,e)}this.members.add(e),this.membersReplicas.set(e,t)}_remove({key:e,replicas:t}){for(let n=0;n<t;n++){const r=this.hasher(oe(e,n));this.circle.delete(r)}this.members.delete(e),this.membersReplicas.delete(e)}get(e){var r;if(this.circle.size===0)return null;const t=this.hasher(e),n=(r=this.sortedHashes.find(i=>i>t))!=null?r:this.sortedHashes[0];return this.circle.get(n)}add(e,t){return this.members.has(e)?!1:(this._add({key:e,replicas:t}),this.updateSortedHashes(),!0)}remove(e){if(!this.members.has(e))return!1;const t=this.membersReplicas.get(e);return this._remove({key:e,replicas:t}),this.updateSortedHashes(),!0}set(e){this.circle.clear(),this.members.clear(),this.membersReplicas.clear(),e.forEach(t=>{this._add(t)}),this.updateSortedHashes()}}function oe(s,e){return e+s}const Dn=In;function In(s){const e=pe(s);return new Uint32Array(e)[0]}let Bt=!1;function j(s){return(...e)=>{Bt&&console.debug(`[${s}] [${(Date.now()/1e3).toFixed(3)}]`,...e)}}function Ln(){Bt=!0}const Ze="https://api.qiniudns.com/v1/resolve",Pt="https://log.qiniuapi.com",Je="https://pili-zeus.qiniuapi.com/v1/scheduling";function te(s){const e=s.get("Content-Length");return e?parseInt(e,10):null}function Bn(s){const e=s.get("Content-Range");return e==null?null:Pn(e)}function Pn(s){const e=s.trim().toLowerCase(),[t,n]=e.split(/\s+/);if(t!=="bytes")throw new Error(`Unit must be bytes: ${s}`);const[r,i]=n.split("/"),o=i==="*"?null:tt(i),[a,u]=(r.includes("-")?r.split("-"):[null,null]).map(f=>tt(f));return{totalSize:o,start:a,end:u}}function et(s){const e=s.start!=null&&s.end!=null?`${s.start}-${s.end}`:"*",t=s.totalSize==null?"*":s.totalSize+"";return`bytes ${e}/${t}`}function tt(s){return s?Number(s):null}function me(s){const e=s.get("Range");return e==null?null:Ot(e)}function Mt(s){return s.start===0&&s.end==null}function Ot(s){const e=s.trim().toLowerCase();if(!e.startsWith("bytes="))throw new Error(`Unit must be bytes: ${s}`);if(e.includes(","))throw new Error(`Multiple range: ${s}`);const[,t,n]=/(\d*)-(\d*)/.exec(e)||[];if(!t&&!n)throw new Error(`Invalid range values: ${s}`);if(!t)throw new Error("Suffix range not supported");const[r,i]=[t,n].map(o=>tt(o));return{start:r,end:i}}function Be(s){var e,t;return`bytes=${(e=s.start)!=null?e:0}-${(t=s.end)!=null?t:""}`}function Ht(s){return Object.keys(s).map(e=>[e,s[e]]).filter(([e,t])=>t!==void 0).map(([e,t])=>t===null?e:[e,t].map(encodeURIComponent).join("=")).join("&")}const Mn=/[^\u0000-\u00ff]/;function Ut(s){return Mn.test(s)?"REPLACED_BY_Miku_SEE_Miku_utils_http_encodeHeaderValue":s}function zt(s){if(s instanceof Headers){const e={};s.forEach((t,n)=>{e[n]=Ut(t)}),s=e}if(Array.isArray(s)){const e={};s.forEach(([t,n])=>{e[n]=Ut(t)}),s=e}return new Headers(s)}function Nt(s){var t;const e=Bn(s);return e!=null?(t=e.totalSize)!=null?t:null:te(s)}var Y=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function On(s){var e=s.default;if(typeof e=="function"){var t=function(){return e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(s).forEach(function(n){var r=Object.getOwnPropertyDescriptor(s,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return s[n]}})}),t}var Ft={exports:{}};function Hn(s){throw new Error('Could not dynamically require "'+s+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var nt={exports:{}};const Un=On(Object.freeze(Object.defineProperty({__proto__:null,default:{}},Symbol.toStringTag,{value:"Module"})));var Wt;function Pe(){return Wt||(Wt=1,function(s,e){(function(t,n){s.exports=n()})(Y,function(){var t=t||function(n,r){var i;if(typeof window!="undefined"&&window.crypto&&(i=window.crypto),typeof self!="undefined"&&self.crypto&&(i=self.crypto),typeof globalThis!="undefined"&&globalThis.crypto&&(i=globalThis.crypto),!i&&typeof window!="undefined"&&window.msCrypto&&(i=window.msCrypto),!i&&typeof Y!="undefined"&&Y.crypto&&(i=Y.crypto),!i&&typeof Hn=="function")try{i=Un}catch(m){}var o=function(){if(i){if(typeof i.getRandomValues=="function")try{return i.getRandomValues(new Uint32Array(1))[0]}catch(m){}if(typeof i.randomBytes=="function")try{return i.randomBytes(4).readInt32LE()}catch(m){}}throw new Error("Native crypto module could not be used to get secure random number.")},a=Object.create||function(){function m(){}return function(g){var y;return m.prototype=g,y=new m,m.prototype=null,y}}(),u={},f=u.lib={},c=f.Base=function(){return{extend:function(m){var g=a(this);return m&&g.mixIn(m),(!g.hasOwnProperty("init")||this.init===g.init)&&(g.init=function(){g.$super.init.apply(this,arguments)}),g.init.prototype=g,g.$super=this,g},create:function(){var m=this.extend();return m.init.apply(m,arguments),m},init:function(){},mixIn:function(m){for(var g in m)m.hasOwnProperty(g)&&(this[g]=m[g]);m.hasOwnProperty("toString")&&(this.toString=m.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),p=f.WordArray=c.extend({init:function(m,g){m=this.words=m||[],g!=r?this.sigBytes=g:this.sigBytes=m.length*4},toString:function(m){return(m||h).stringify(this)},concat:function(m){var g=this.words,y=m.words,E=this.sigBytes,k=m.sigBytes;if(this.clamp(),E%4)for(var I=0;I<k;I++){var q=y[I>>>2]>>>24-I%4*8&255;g[E+I>>>2]|=q<<24-(E+I)%4*8}else for(var z=0;z<k;z+=4)g[E+z>>>2]=y[z>>>2];return this.sigBytes+=k,this},clamp:function(){var m=this.words,g=this.sigBytes;m[g>>>2]&=4294967295<<32-g%4*8,m.length=n.ceil(g/4)},clone:function(){var m=c.clone.call(this);return m.words=this.words.slice(0),m},random:function(m){for(var g=[],y=0;y<m;y+=4)g.push(o());return new p.init(g,m)}}),l=u.enc={},h=l.Hex={stringify:function(m){for(var g=m.words,y=m.sigBytes,E=[],k=0;k<y;k++){var I=g[k>>>2]>>>24-k%4*8&255;E.push((I>>>4).toString(16)),E.push((I&15).toString(16))}return E.join("")},parse:function(m){for(var g=m.length,y=[],E=0;E<g;E+=2)y[E>>>3]|=parseInt(m.substr(E,2),16)<<24-E%8*4;return new p.init(y,g/2)}},d=l.Latin1={stringify:function(m){for(var g=m.words,y=m.sigBytes,E=[],k=0;k<y;k++){var I=g[k>>>2]>>>24-k%4*8&255;E.push(String.fromCharCode(I))}return E.join("")},parse:function(m){for(var g=m.length,y=[],E=0;E<g;E++)y[E>>>2]|=(m.charCodeAt(E)&255)<<24-E%4*8;return new p.init(y,g)}},w=l.Utf8={stringify:function(m){try{return decodeURIComponent(escape(d.stringify(m)))}catch(g){throw new Error("Malformed UTF-8 data")}},parse:function(m){return d.parse(unescape(encodeURIComponent(m)))}},b=f.BufferedBlockAlgorithm=c.extend({reset:function(){this._data=new p.init,this._nDataBytes=0},_append:function(m){typeof m=="string"&&(m=w.parse(m)),this._data.concat(m),this._nDataBytes+=m.sigBytes},_process:function(m){var g,y=this._data,E=y.words,k=y.sigBytes,I=this.blockSize,q=I*4,z=k/q;m?z=n.ceil(z):z=n.max((z|0)-this._minBufferSize,0);var W=z*I,J=n.min(W*4,k);if(W){for(var N=0;N<W;N+=I)this._doProcessBlock(E,N);g=E.splice(0,W),y.sigBytes-=J}return new p.init(g,J)},clone:function(){var m=c.clone.call(this);return m._data=this._data.clone(),m},_minBufferSize:0});f.Hasher=b.extend({cfg:c.extend(),init:function(m){this.cfg=this.cfg.extend(m),this.reset()},reset:function(){b.reset.call(this),this._doReset()},update:function(m){return this._append(m),this._process(),this},finalize:function(m){m&&this._append(m);var g=this._doFinalize();return g},blockSize:16,_createHelper:function(m){return function(g,y){return new m.init(y).finalize(g)}},_createHmacHelper:function(m){return function(g,y){return new S.HMAC.init(m,y).finalize(g)}}});var S=u.algo={};return u}(Math);return t})}(nt)),nt.exports}var st={exports:{}},$t;function zn(){return $t||($t=1,function(s,e){(function(t,n){s.exports=n(Pe())})(Y,function(t){return function(){var n=t,r=n.lib,i=r.WordArray,o=r.Hasher,a=n.algo,u=[],f=a.SHA1=o.extend({_doReset:function(){this._hash=new i.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(c,p){for(var l=this._hash.words,h=l[0],d=l[1],w=l[2],b=l[3],S=l[4],m=0;m<80;m++){if(m<16)u[m]=c[p+m]|0;else{var g=u[m-3]^u[m-8]^u[m-14]^u[m-16];u[m]=g<<1|g>>>31}var y=(h<<5|h>>>27)+S+u[m];m<20?y+=(d&w|~d&b)+1518500249:m<40?y+=(d^w^b)+1859775393:m<60?y+=(d&w|d&b|w&b)-1894007588:y+=(d^w^b)-899497514,S=b,b=w,w=d<<30|d>>>2,d=h,h=y}l[0]=l[0]+h|0,l[1]=l[1]+d|0,l[2]=l[2]+w|0,l[3]=l[3]+b|0,l[4]=l[4]+S|0},_doFinalize:function(){var c=this._data,p=c.words,l=this._nDataBytes*8,h=c.sigBytes*8;return p[h>>>5]|=128<<24-h%32,p[(h+64>>>9<<4)+14]=Math.floor(l/4294967296),p[(h+64>>>9<<4)+15]=l,c.sigBytes=p.length*4,this._process(),this._hash},clone:function(){var c=o.clone.call(this);return c._hash=this._hash.clone(),c}});n.SHA1=o._createHelper(f),n.HmacSHA1=o._createHmacHelper(f)}(),t.SHA1})}(st)),st.exports}var rt={exports:{}},qt;function Nn(){return qt||(qt=1,function(s,e){(function(t,n){s.exports=n(Pe())})(Y,function(t){(function(){var n=t,r=n.lib,i=r.Base,o=n.enc,a=o.Utf8,u=n.algo;u.HMAC=i.extend({init:function(f,c){f=this._hasher=new f.init,typeof c=="string"&&(c=a.parse(c));var p=f.blockSize,l=p*4;c.sigBytes>l&&(c=f.finalize(c)),c.clamp();for(var h=this._oKey=c.clone(),d=this._iKey=c.clone(),w=h.words,b=d.words,S=0;S<p;S++)w[S]^=1549556828,b[S]^=909522486;h.sigBytes=d.sigBytes=l,this.reset()},reset:function(){var f=this._hasher;f.reset(),f.update(this._iKey)},update:function(f){return this._hasher.update(f),this},finalize:function(f){var c=this._hasher,p=c.finalize(f);c.reset();var l=c.finalize(this._oKey.clone().concat(p));return l}})})()})}(rt)),rt.exports}(function(s,e){(function(t,n,r){s.exports=n(Pe(),zn(),Nn())})(Y,function(t){return t.HmacSHA1})})(Ft);const Fn=Ft.exports;var jt={exports:{}};(function(s,e){(function(t,n){s.exports=n(Pe())})(Y,function(t){return function(){var n=t,r=n.lib,i=r.WordArray,o=n.enc;o.Base64={stringify:function(u){var f=u.words,c=u.sigBytes,p=this._map;u.clamp();for(var l=[],h=0;h<c;h+=3)for(var d=f[h>>>2]>>>24-h%4*8&255,w=f[h+1>>>2]>>>24-(h+1)%4*8&255,b=f[h+2>>>2]>>>24-(h+2)%4*8&255,S=d<<16|w<<8|b,m=0;m<4&&h+m*.75<c;m++)l.push(p.charAt(S>>>6*(3-m)&63));var g=p.charAt(64);if(g)for(;l.length%4;)l.push(g);return l.join("")},parse:function(u){var f=u.length,c=this._map,p=this._reverseMap;if(!p){p=this._reverseMap=[];for(var l=0;l<c.length;l++)p[c.charCodeAt(l)]=l}var h=c.charAt(64);if(h){var d=u.indexOf(h);d!==-1&&(f=d)}return a(u,f,p)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="};function a(u,f,c){for(var p=[],l=0,h=0;h<f;h++)if(h%4){var d=c[u.charCodeAt(h-1)]<<h%4*2,w=c[u.charCodeAt(h)]>>>6-h%4*2,b=d|w;p[l>>>2]|=b<<24-l%4*8,l++}return i.create(p,l)}}(),t.enc.Base64})})(jt);const Wn=jt.exports;function $n(s){let e=s.query?`${s.path}?${s.query}
`:`${s.path}
`;return s.body&&(e+=s.body),e}function it(s){let e;try{e=new URL(s.path).pathname}catch(a){e=s.path}let t=$n($(T({},s),{path:e}));const i=Fn(t,s.appSalt).toString(Wn).replace(/\+/g,"-").replace(/\//g,"_");let o=`QApp ${s.appID}:${i}`;return o=o.replace(/\//g,"_"),o=o.replace(/\+/g,"-"),o}const qn=new URL(Ze).hostname;function jn(s,e,t){return v(this,null,function*(){var u;const r=Ht({name:e,type:"A"}),i=it({appID:t.appID,appSalt:t.appSalt,path:Ze,query:r}),o=yield fetch(`${Ze}?${r}`,{headers:{Authorization:i}});if(s.set("dnsResolveStatus",o.status),s.set("dnsResolveReqID",(u=o.headers.get("x-reqid"))!=null?u:""),s.set("dnsResolveConnectionAt",Date.now()),s.set("dnsResolveServiceDomain",qn),!o.ok)throw new Error(`Call resolve API failed, status: ${o.status} ${o.statusText}`);return yield o.json()})}class Vn{constructor(e){this.logger=e}log(e){return this.logger.log("DnsResolveLog",e)}}function ot(){const s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",e=s.length;let t="";for(let n=0;n<20;n++)t+=s[Math.floor(Math.random()*e)];return t}function Gn(s,e){const t={};return Object.keys(s).forEach(n=>{t[n]=e(s[n])}),t}function Kn(){const s={resolve:void 0,reject:void 0,promise:void 0,status:"pending",value:null};return s.promise=new Promise((e,t)=>{s.resolve=e,s.reject=t}),s.promise.then(e=>{s.value=e,s.status="resolved"},()=>{s.status="rejected"}),s}class Vt extends Error{constructor(){super(...arguments);R(this,"name","TimeoutError")}}function Xn(s,e){return new Promise((t,n)=>{setTimeout(()=>n(new Vt(e+" timeout")),s)})}class Yn extends Error{constructor(){super(...arguments);R(this,"name","AbortError")}}function Gt(s,e){e.aborted?s.abort(e.reason):e.addEventListener("abort",()=>{s.abort(e.reason)})}const Kt={image:[/\.(jpe?g|png|gif|webp|svg|bmp|ico|tiff|avif|svga)$/],media:[/\.(3gp|aac|flac|mpe?g|mp3|mp4|m4a|m4v|m4p|oga|ogg|ogv|wav|webm|mov)$/],live:[/\.(flv|m3u8|ts|m4s)$/],other:[]};function Xt(s,e,t=["image","media","other"]){s.search="",s.hash="";const n=s.toString();return t.some(r=>{var i;return((i=e[r])!=null?i:[]).some(o=>o.test(n))})}function Me(s){const e=new URL(s);return e.search="",e.hash="",e.toString()}function ge(s){return s instanceof Error?{err_msg:s.name,err_desc:s.message}:{err_msg:"Unknown",err_desc:s+""}}function U(s,e){return s==null||s===-1||e==null||e===-1?-1:(s-e)/1e3}function Yt(s,e=80){const[t,n]=s.split(":"),r=n?parseInt(n,10):e;return[t,r]}function Qn(s,e){return new URL(s,e).toString()}function Oe(s){const[e]=s.split("?");return e.endsWith(".m3u8")}function Qt(s){const[e]=s.split("?");return e.endsWith(".flv")}class Zt{constructor(){R(this,"map",new Map)}on(e,t){var i;const r=[...(i=this.map.get(e))!=null?i:[],t];return this.map.set(e,r),()=>this.off(e,t)}once(e,t){const n=this.on(e,r=>{n(),t(r)});return n}off(e,t){var i;const r=((i=this.map.get(e))!=null?i:[]).filter(o=>o!==t);this.map.set(e,r)}emit(...e){var i;const[t,n]=e;((i=this.map.get(t))!=null?i:[]).forEach(o=>{o(n)})}dispose(){this.map.clear()}}const Zn=self,at=j("utils/sw/clients");class Jn{constructor(e=Zn){R(this,"clientIds",[]);R(this,"removed",new Set);R(this,"emitter",new Zt);this.swScope=e}add(e){this.clientIds.includes(e)||this.removed.has(e)||(this.clientIds.push(e),at("add",e,this.clientIds))}remove(e){const t=this.clientIds.indexOf(e);t<0||(this.clientIds.splice(t,1),this.removed.add(e),this.emitter.emit("remove",e),at("remove",e,this.clientIds))}set(e){const t=this.clientIds,n=[],r=[];t.forEach(i=>{const o=e.indexOf(i);o>=0?(n.push(i),e.splice(o,1)):r.push(i)}),this.clientIds=[...n,...e],r.forEach(i=>{this.emitter.emit("remove",i)}),(r.length>0||e.length>0)&&at("set",this.clientIds)}getAllIds(){return this.clientIds}getAll(){return v(this,null,function*(){const e=(yield this.swScope.clients.matchAll({type:"window"})).slice();return e.reverse(),this.set(e.map(t=>t.id)),this.clientIds.map(t=>e.find(n=>n.id===t))})}get(e){return v(this,null,function*(){const t=yield this.swScope.clients.get(e);return t!=null?this.add(e):this.remove(e),t})}onRemove(e){return this.emitter.on("remove",e)}whenRemoved(e,t){if(!this.clientIds.includes(e))return;const n=this.emitter.on("remove",r=>{r===e&&(n(),t())})}}const ae=new Jn;function es(s){return v(this,null,function*(){const e=s.getReader();let t=new Uint8Array;for(;;){const{done:r,value:i}=yield e.read();if(r)break;t=new Uint8Array([...t,...i])}return new TextDecoder().decode(t)})}function ts(s,e){const t=s.getReader(),n=Kn();let r=0;const i=new ReadableStream({pull:a=>v(this,null,function*(){const{value:u,done:f}=yield t.read();if(f){a.close(),n.resolve(null);return}const c=r+u.byteLength;if(e>c){a.enqueue(u),r=c;return}const p=u.slice(0,e-r);a.enqueue(p),a.close();const l=e<c?u.slice(e-r):null;n.resolve(l)}),cancel:a=>t.cancel(a)}),o=new ReadableStream({start:a=>v(this,null,function*(){const u=yield n.promise;u!=null&&a.enqueue(u)}),pull:a=>v(this,null,function*(){const{value:u,done:f}=yield t.read();if(f){a.close();return}a.enqueue(u)}),cancel:a=>t.cancel(a)});return[i,o]}function lt(s,e){var a;const t=s.getReader(),n=(a=e[0])!=null?a:0,r=e[1];let i=0;return new ReadableStream({pull:u=>v(this,null,function*(){let f,c;for(;;){const d=yield t.read();if(d.done){u.close();return}if(f=d.value,c=i+f.byteLength,c>n)break;i=c}let p=f;const l=n>i?n-i:0,h=r!=null&&r<c?r-i:void 0;(l!==0||h!==void 0)&&(p=f.slice(l,h)),u.enqueue(p),r!=null&&c>=r&&(t.cancel("Cancelled by slice for target range met"),u.close()),i=c}),cancel:u=>t.cancel(u)})}function ns(s){let e=0;const t=new TransformStream({transform:(r,i)=>{e+=r.byteLength,i.enqueue(r)}}),n=s.pipeTo(t.writable).then(()=>({size:e,success:!0}),r=>({size:e,success:!1,error:r}));return[t.readable,n]}function ss(s){let e,t=!1;const n=new ReadableStream({start:a=>{e=a},cancel:()=>{t=!0}}),r=s.getReader();let i=!1;return{main:new ReadableStream({pull:a=>v(this,null,function*(){try{const{value:u,done:f}=yield r.read();if(i)return;if(f){a.close(),t||e.close();return}a.enqueue(u),t||e.enqueue(u)}catch(u){a.error(u),t||e.error(u)}}),cancel:a=>v(this,null,function*(){i=!0,yield r.cancel(a),e.error(a)})}),minor:n}}var ct={exports:{}};(function(s,e){(function(t,n){var r="1.0.2",i="",o="?",a="function",u="undefined",f="object",c="string",p="major",l="model",h="name",d="type",w="vendor",b="version",S="architecture",m="console",g="mobile",y="tablet",E="smarttv",k="wearable",I="embedded",q=255,z="Amazon",W="Apple",J="ASUS",N="BlackBerry",O="Browser",re="Chrome",ee="Edge",K="Firefox",ie="Google",fe="Huawei",Te="LG",_t="Microsoft",yn="Motorola",je="Opera",Tt="Samsung",At="Sony",Rn="Xiaomi",kt="Zebra",Sn="Facebook",Rr=function(C,A){var x={};for(var H in C)A[H]&&A[H].length%2===0?x[H]=A[H].concat(C[H]):x[H]=C[H];return x},Ve=function(C){for(var A={},x=0;x<C.length;x++)A[C[x].toUpperCase()]=C[x];return A},En=function(C,A){return typeof C===c?Ae(A).indexOf(Ae(C))!==-1:!1},Ae=function(C){return C.toLowerCase()},Sr=function(C){return typeof C===c?C.replace(/[^\d\.]/g,i).split(".")[0]:n},Dt=function(C,A){if(typeof C===c)return C=C.replace(/^\s\s*/,i).replace(/\s\s*$/,i),typeof A===u?C:C.substring(0,q)},ke=function(C,A){for(var x=0,H,_,Ke,L,De,X;x<A.length&&!De;){var _n=A[x],Tn=A[x+1];for(H=_=0;H<_n.length&&!De;)if(De=_n[H++].exec(C),De)for(Ke=0;Ke<Tn.length;Ke++)X=De[++_],L=Tn[Ke],typeof L===f&&L.length>0?L.length===2?typeof L[1]==a?this[L[0]]=L[1].call(this,X):this[L[0]]=L[1]:L.length===3?typeof L[1]===a&&!(L[1].exec&&L[1].test)?this[L[0]]=X?L[1].call(this,X,L[2]):n:this[L[0]]=X?X.replace(L[1],L[2]):n:L.length===4&&(this[L[0]]=X?L[3].call(this,X.replace(L[1],L[2])):n):this[L]=X||n;x+=2}},It=function(C,A){for(var x in A)if(typeof A[x]===f&&A[x].length>0){for(var H=0;H<A[x].length;H++)if(En(A[x][H],C))return x===o?n:x}else if(En(A[x],C))return x===o?n:x;return C},Er={"1.0":"/8","1.2":"/1","1.3":"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"},Cn={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2","8.1":"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},xn={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[b,[h,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[b,[h,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[h,b],[/opios[\/ ]+([\w\.]+)/i],[b,[h,je+" Mini"]],[/\bopr\/([\w\.]+)/i],[b,[h,je]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale|qqbrowserlite|qq)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[h,b],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[b,[h,"UC"+O]],[/\bqbcore\/([\w\.]+)/i],[b,[h,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[b,[h,"WeChat"]],[/konqueror\/([\w\.]+)/i],[b,[h,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[b,[h,"IE"]],[/yabrowser\/([\w\.]+)/i],[b,[h,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[h,/(.+)/,"$1 Secure "+O],b],[/\bfocus\/([\w\.]+)/i],[b,[h,K+" Focus"]],[/\bopt\/([\w\.]+)/i],[b,[h,je+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[b,[h,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[b,[h,"Dolphin"]],[/coast\/([\w\.]+)/i],[b,[h,je+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[b,[h,"MIUI "+O]],[/fxios\/([-\w\.]+)/i],[b,[h,K]],[/\bqihu|(qi?ho?o?|360)browser/i],[[h,"360 "+O]],[/(oculus|samsung|sailfish)browser\/([\w\.]+)/i],[[h,/(.+)/,"$1 "+O],b],[/(comodo_dragon)\/([\w\.]+)/i],[[h,/_/g," "],b],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[h,b],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i],[h],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[h,Sn],b],[/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[h,b],[/\bgsa\/([\w\.]+) .*safari\//i],[b,[h,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[b,[h,re+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[h,re+" WebView"],b],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[b,[h,"Android "+O]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[h,b],[/version\/([\w\.]+) .*mobile\/\w+ (safari)/i],[b,[h,"Mobile Safari"]],[/version\/([\w\.]+) .*(mobile ?safari|safari)/i],[b,h],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[h,[b,It,Er]],[/(webkit|khtml)\/([\w\.]+)/i],[h,b],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[h,"Netscape"],b],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[b,[h,K+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i],[h,b]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[S,"amd64"]],[/(ia32(?=;))/i],[[S,Ae]],[/((?:i[346]|x)86)[;\)]/i],[[S,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[S,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[S,"armhf"]],[/windows (ce|mobile); ppc;/i],[[S,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[S,/ower/,i,Ae]],[/(sun4\w)[;\)]/i],[[S,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[S,Ae]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[pt]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[l,[w,Tt],[d,y]],[/\b((?:s[cgp]h|gt|sm)-\w+|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[l,[w,Tt],[d,g]],[/\((ip(?:hone|od)[\w ]*);/i],[l,[w,W],[d,g]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[l,[w,W],[d,y]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[l,[w,fe],[d,y]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}-[atu]?[ln][01259x][012359][an]?)\b(?!.+d\/s)/i],[l,[w,fe],[d,g]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[l,/_/g," "],[w,Rn],[d,g]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[l,/_/g," "],[w,Rn],[d,y]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[l,[w,"OPPO"],[d,g]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[l,[w,"Vivo"],[d,g]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[l,[w,"Realme"],[d,g]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[l,[w,yn],[d,g]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[l,[w,yn],[d,y]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[l,[w,Te],[d,y]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[l,[w,Te],[d,g]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[l,[w,"Lenovo"],[d,y]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[l,/_/g," "],[w,"Nokia"],[d,g]],[/(pixel c)\b/i],[l,[w,ie],[d,y]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[l,[w,ie],[d,g]],[/droid.+ ([c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[l,[w,At],[d,g]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[l,"Xperia Tablet"],[w,At],[d,y]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[l,[w,"OnePlus"],[d,g]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[l,[w,z],[d,y]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[l,/(.+)/g,"Fire Phone $1"],[w,z],[d,g]],[/(playbook);[-\w\),; ]+(rim)/i],[l,w,[d,y]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[l,[w,N],[d,g]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[l,[w,J],[d,y]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[l,[w,J],[d,g]],[/(nexus 9)/i],[l,[w,"HTC"],[d,y]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic|sony)[-_ ]?([-\w]*)/i],[w,[l,/_/g," "],[d,g]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[l,[w,"Acer"],[d,y]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[l,[w,"Meizu"],[d,g]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[l,[w,"Sharp"],[d,g]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[w,l,[d,g]],[/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[w,l,[d,y]],[/(surface duo)/i],[l,[w,_t],[d,y]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[l,[w,"Fairphone"],[d,g]],[/(u304aa)/i],[l,[w,"AT&T"],[d,g]],[/\bsie-(\w*)/i],[l,[w,"Siemens"],[d,g]],[/\b(rct\w+) b/i],[l,[w,"RCA"],[d,y]],[/\b(venue[\d ]{2,7}) b/i],[l,[w,"Dell"],[d,y]],[/\b(q(?:mv|ta)\w+) b/i],[l,[w,"Verizon"],[d,y]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[l,[w,"Barnes & Noble"],[d,y]],[/\b(tm\d{3}\w+) b/i],[l,[w,"NuVision"],[d,y]],[/\b(k88) b/i],[l,[w,"ZTE"],[d,y]],[/\b(nx\d{3}j) b/i],[l,[w,"ZTE"],[d,g]],[/\b(gen\d{3}) b.+49h/i],[l,[w,"Swiss"],[d,g]],[/\b(zur\d{3}) b/i],[l,[w,"Swiss"],[d,y]],[/\b((zeki)?tb.*\b) b/i],[l,[w,"Zeki"],[d,y]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[w,"Dragon Touch"],l,[d,y]],[/\b(ns-?\w{0,9}) b/i],[l,[w,"Insignia"],[d,y]],[/\b((nxa|next)-?\w{0,9}) b/i],[l,[w,"NextBook"],[d,y]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[w,"Voice"],l,[d,g]],[/\b(lvtel\-)?(v1[12]) b/i],[[w,"LvTel"],l,[d,g]],[/\b(ph-1) /i],[l,[w,"Essential"],[d,g]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[l,[w,"Envizen"],[d,y]],[/\b(trio[-\w\. ]+) b/i],[l,[w,"MachSpeed"],[d,y]],[/\btu_(1491) b/i],[l,[w,"Rotor"],[d,y]],[/(shield[\w ]+) b/i],[l,[w,"Nvidia"],[d,y]],[/(sprint) (\w+)/i],[w,l,[d,g]],[/(kin\.[onetw]{3})/i],[[l,/\./g," "],[w,_t],[d,g]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[l,[w,kt],[d,y]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[l,[w,kt],[d,g]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[w,l,[d,m]],[/droid.+; (shield) bui/i],[l,[w,"Nvidia"],[d,m]],[/(playstation [345portablevi]+)/i],[l,[w,At],[d,m]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[l,[w,_t],[d,m]],[/smart-tv.+(samsung)/i],[w,[d,E]],[/hbbtv.+maple;(\d+)/i],[[l,/^/,"SmartTV"],[w,Tt],[d,E]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[w,Te],[d,E]],[/(apple) ?tv/i],[w,[l,W+" TV"],[d,E]],[/crkey/i],[[l,re+"cast"],[w,ie],[d,E]],[/droid.+aft(\w)( bui|\))/i],[l,[w,z],[d,E]],[/\(dtv[\);].+(aquos)/i],[l,[w,"Sharp"],[d,E]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w ]*; *(\w[^;]*);([^;]*)/i],[[w,Dt],[l,Dt],[d,E]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[d,E]],[/((pebble))app/i],[w,l,[d,k]],[/droid.+; (glass) \d/i],[l,[w,ie],[d,k]],[/droid.+; (wt63?0{2,3})\)/i],[l,[w,kt],[d,k]],[/(quest( 2)?)/i],[l,[w,Sn],[d,k]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[w,[d,I]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[l,[d,g]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[l,[d,y]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[d,y]],[/(phone|mobile(?:[;\/]| safari)|pda(?=.+windows ce))/i],[[d,g]],[/(android[-\w\. ]{0,9});.+buil/i],[l,[w,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[b,[h,ee+"HTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[b,[h,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[h,b],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[b,h]],os:[[/microsoft (windows) (vista|xp)/i],[h,b],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[h,[b,It,Cn]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[h,"Windows"],[b,It,Cn]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[b,/_/g,"."],[h,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[h,"Mac OS"],[b,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86)/i],[b,h],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[h,b],[/\(bb(10);/i],[b,[h,N]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[b,[h,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[b,[h,K+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[b,[h,"webOS"]],[/crkey\/([\d\.]+)/i],[b,[h,re+"cast"]],[/(cros) [\w]+ ([\w\.]+\w)/i],[[h,"Chromium OS"],b],[/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[h,b],[/(sunos) ?([\w\.\d]*)/i],[[h,"Solaris"],b],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[h,b]]},G=function(C,A){if(typeof C===f&&(A=C,C=n),!(this instanceof G))return new G(C,A).getResult();var x=C||(typeof t!==u&&t.navigator&&t.navigator.userAgent?t.navigator.userAgent:i),H=A?Rr(xn,A):xn;return this.getBrowser=function(){var _={};return _[h]=n,_[b]=n,ke.call(_,x,H.browser),_.major=Sr(_.version),_},this.getCPU=function(){var _={};return _[S]=n,ke.call(_,x,H.cpu),_},this.getDevice=function(){var _={};return _[w]=n,_[l]=n,_[d]=n,ke.call(_,x,H.device),_},this.getEngine=function(){var _={};return _[h]=n,_[b]=n,ke.call(_,x,H.engine),_},this.getOS=function(){var _={};return _[h]=n,_[b]=n,ke.call(_,x,H.os),_},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return x},this.setUA=function(_){return x=typeof _===c&&_.length>q?Dt(_,q):_,this},this.setUA(x),this};G.VERSION=r,G.BROWSER=Ve([h,b,p]),G.CPU=Ve([S]),G.DEVICE=Ve([l,w,d,m,g,E,y,k,I]),G.ENGINE=G.OS=Ve([h,b]),s.exports&&(e=s.exports=G),e.UAParser=G;var we=typeof t!==u&&(t.jQuery||t.Zepto);if(we&&!we.ua){var Ge=new G;we.ua=Ge.getResult(),we.ua.get=function(){return Ge.getUA()},we.ua.set=function(C){Ge.setUA(C);var A=Ge.getResult();for(var x in A)we.ua[x]=A[x]}}})(typeof window=="object"?window:Y)})(ct,ct.exports);const ut=ct.exports;ut(navigator.userAgent);let be;function He(){if(be!=null)return be;try{new Response(new ReadableStream),be=!0}catch(s){be=!1}return be}function ve(){return!(typeof TransformStream=="undefined"||!He())}class le{constructor(e,{method:t,headers:n,signal:r,body:i}){R(this,"url");R(this,"method");R(this,"headers");R(this,"body");R(this,"signal");this.url=e,this.method=t!=null?t:"GET",this.headers=new Headers(n),this.body=i!=null?i:null,this.signal=r!=null?r:new AbortController().signal}}class ne{constructor(e,{status:t,statusText:n,headers:r,underlayer:i}){R(this,"status");R(this,"statusText");R(this,"headers");R(this,"body");R(this,"bodyReadResult");R(this,"underlayer");if(this.status=t!=null?t:200,this.statusText=n!=null?n:"",this.headers=zt(r),this.underlayer=i,e==null||!ve())this.body=e,this.bodyReadResult=Promise.resolve({success:!0,size:0});else{const[o,a]=ns(e);this.body=o,this.bodyReadResult=a}}}function Ue(s){const{status:e,statusText:t,headers:n,body:r}=s;return new ne(r,{status:e,statusText:t,headers:n,underlayer:s})}class ze extends Error{constructor(t){super(`Unexpected HTTP status: ${t.status} ${t.statusText}`);R(this,"name","UnexpectedHttpStatusError");this.response=t}}const rs=new Zt;let Jt;typeof self!="undefined"&&(Jt=self,Jt.addEventListener("message",s=>rs.emit("message",s)));class is extends Error{constructor(){super(...arguments);R(this,"name","WindowClientError")}}class os extends Error{constructor(){super(...arguments);R(this,"name","UnexpectedDataChannelCloseError")}}class as extends Error{constructor(){super(...arguments);R(this,"name","UnexpectedDataChannel1stMessageError")}}function en(s,e=()=>1){if(s.length===0)return null;const t=s.map(e),n=t.reduce((i,o)=>i+o,0);let r=Math.random()*n;for(let i=0;i<t.length;i++){const o=t[i];if(r<o)return s[i];r-=o}return s[0]}function se(s){return s&&s.name==="AbortError"}const ls=new os().name,cs=new as().name;function Ne(s){return!(s&&[ls,cs].includes(s.name)||se(s)||s instanceof is)}class ht extends Error{constructor(t){super(t+"");R(this,"name","ResolveError");this.cause=t}}class dt extends Error{constructor(){super(...arguments);R(this,"name","NoAvailableNodeError")}}class ft extends Error{constructor(t){super(t+"");R(this,"name","DoWithNodeError");this.cause=t}}class ce extends Error{constructor(){super(...arguments);R(this,"name","LocalDNSError")}}const ye=j("dns");class tn{constructor(e,t,n=jn){R(this,"cache",new Map);R(this,"logger");R(this,"fingerprints",new Map);this.app=t,this.dnsResolver=n,this.logger=new Vn(e)}getFingerprint(e){const t=this.fingerprints.get(e);if(t==null)throw new Error(`No fingerprint for ${e}`);return t}getResolveResult(e,t){return v(this,null,function*(){var a,u,f,c;const n=Date.now();let r,i;try{let p;try{p=yield this.dnsResolver(e,t,this.app)}catch(w){throw console.warn("DNS resolve failed:",w),new ht(w)}if(!ds(p))throw new ce(`Non-ECDN domain: ${t}`);if(p.groups.length===0)throw new dt(`No available group for ${t}`);const o=p,{groups:l}=o,h=Ie(o,["groups"]),d=[];return l.forEach(w=>{w.elts.forEach(S=>{S.ips.forEach(m=>{this.fingerprints.set(m,S.fingerprint)})});const b=new V;b.set(w.elts.map(S=>({key:S.id,replicas:S.replicas}))),d.push($(T({},w),{consistentHash:b}))}),i=$(T({},h),{expireAt:Date.now()+p.ttl*1e3,groups:d}),i}catch(p){throw r=p,p}finally{const p=U(Date.now(),n),l=i==null?ge(r):{err_msg:"",err_desc:""};this.logger.log($(T({r_id:(a=e.get("dnsResolveReqID"))!=null?a:"",ip:(u=e.get("dnsResolveServiceIP"))!=null?u:"",domain:(f=e.get("dnsResolveServiceDomain"))!=null?f:"",status_code:(c=e.get("dnsResolveStatus"))!=null?c:-1},l),{t_conn:U(e.get("dnsResolveConnectionAt"),n),t_total:p,type:1})),e.set("dnsResolveTotalTime",p)}})}resolveDomain(e,t){return v(this,null,function*(){const n=this.cache.get(t);if(n!=null){let i;try{i=yield n}catch(o){if(o instanceof ce||o instanceof dt)throw o}if(i!=null&&i.expireAt>Date.now())return e.set("dnsResolveFromCache",!0),i;this.cache.delete(t)}const r=this.getResolveResult(e,t);return this.cache.set(t,r),r})}resolve(e,t,n=!1){return v(this,null,function*(){let r=null;return yield this.do(e,t,1,n,i=>{r=i}),r})}do(e,t,n,r,i){return v(this,null,function*(){const o=new URL(t);if(o.port!=="")throw new Error("TODO: no port");let a;ye("Resolve for",t);let{groups:u}=yield this.resolveDomain(e,o.host);ye("Resolved for",t);for(let f=0;f<n;f++){const c=en(u,p=>p.weight);if(c==null)break;try{ye("doWithGroup",f,t),yield us(c,t,r,i);return}catch(p){if(console.warn("doWithGroup (weight:",c.weight,") failed:",p,t),a=p,se(p))break;Ne(p)&&(u=u.filter(l=>l!==c))}}throw a=se(a)?a:new ft(a),a})}}function us(s,e,t,n){return v(this,null,function*(){const r=s.elts;if(r.length===0)throw new Error("Empty elt list");if(!s.consistentHash)throw new Error("no consistentHash");const i=s.consistentHash.clone();let o;for(let a=0;a<2;a++){const u=i.get(e);if(u==null)break;const f=r.find(c=>c.id===u);if(f==null)throw new Error("No available elt");try{ye("doWithElt",f.id,e),yield hs(f,e,t,n);return}catch(c){if(console.warn("doWithElt",f.id,"failed:",c,e),o=c,se(c))break;Ne(c)&&i.remove(u)}}throw o})}function hs(s,e,t,n){return v(this,null,function*(){let r=t?s.hosts:s.ips;if(r.length===0)throw new Error(`Empty ${t?"host":"IP"} list`);let i;for(let o=0;o<2;o++){const a=en(r);if(a==null)break;try{ye(`do with ${t?"host":"IP"}`,a,e),yield n(a);return}catch(u){if(console.warn("do job with",a,"failed:",u,e),i=u,se(u))break;Ne(u)&&(r=r.filter(f=>f!==a))}}throw i})}function ds(s){return s.groups!=null}const fs=new URL(Je).hostname;function ws(s,e,t){return v(this,null,function*(){var a;const n={url:e,cip:""},r=it({appID:t.appID,appSalt:t.appSalt,path:Je}),i=yield fetch(Je,{method:"POST",body:JSON.stringify(n),headers:{"Content-Type":"application/json",Authorization:r}});if(s.set("dnsResolveStatus",i.status),s.set("dnsResolveReqID",(a=i.headers.get("x-reqid"))!=null?a:""),s.set("dnsResolveConnectionAt",Date.now()),s.set("dnsResolveServiceDomain",fs),!i.ok)throw new Error(`Call Schedule API failed, status: ${i.status} ${i.statusText}`);return yield i.json()})}class ps{constructor(e){this.logger=e}log(e){return this.logger.log("LiveScheduleLog",e)}}const Re=j("dns"),ms=60,gs=60*1e3;class nn{constructor(e,t,n=ws,r=Me){R(this,"scheduling",new Map);R(this,"cache",new Map);R(this,"m3u8SegmentCache",new Map);R(this,"logger");this.app=t,this.scheduler=n,this.cacheUrl=r,this.logger=new ps(e)}getScheduleResult(e,t){return v(this,null,function*(){var o,a,u,f,c;const n=Date.now();let r,i;try{let p;try{p=yield this.scheduler(e,t,this.app)}catch(h){throw console.warn("Live schedule failed:",h),new ht(h)}if(p.code===1)throw new ce(`Local DNS for ${t}`);if(p.code!==0)throw new Error(`Unexpected schedule code: ${p.code}`);const l=(o=p.ttl)!=null?o:ms;return i=$(T({},p),{expireAt:Date.now()+l*1e3,ips:p.ips.map(h=>({addr:h,after:0})),hosts:p.hosts.map(h=>({addr:h,after:0})),ttl:l}),i}catch(p){throw r=p,p}finally{const p=U(Date.now(),n),l=i==null?ge(r):{err_msg:"",err_desc:""};this.logger.log($(T({r_id:(a=e.get("dnsResolveReqID"))!=null?a:"",ip:(u=e.get("dnsResolveServiceIP"))!=null?u:"",domain:(f=e.get("dnsResolveServiceDomain"))!=null?f:"",status_code:(c=e.get("dnsResolveStatus"))!=null?c:-1},l),{t_conn:U(e.get("dnsResolveConnectionAt"),n),t_total:p,type:1})),e.set("dnsResolveTotalTime",p)}})}saveM3u8SegmentResult(e,t){return v(this,null,function*(){const n=this.cacheUrl(e),r=this.cache.get(n);if(r==null){console.warn("No schedule result for m3u8:",e);return}const i=t.map(this.cacheUrl);i.forEach(o=>{this.m3u8SegmentCache.set(o,r)}),setTimeout(()=>{i.forEach(o=>{this.m3u8SegmentCache.delete(o)})},60*1e3)})}schedule(e,t){return v(this,null,function*(){const n=this.cacheUrl(t);if(!Oe(t)&&!Qt(t)){const a=this.m3u8SegmentCache.get(n);if(a==null)throw new ce("Neither m3u8 / flv URL, or m3u8 segment URL");return a}const r=this.cache.get(n);if(r!=null&&pt(r))return e.set("dnsResolveFromCache",!0),r;const i=this.scheduling.get(n);if(i!=null){let a;try{a=yield i}catch(u){if(u instanceof ce)throw u}if(a!=null&&pt(a))return e.set("dnsResolveFromCache",!0),a;this.scheduling.delete(n)}const o=this.getScheduleResult(e,t);return Re("save scheduling for",t),this.scheduling.set(n,o),o.then(a=>{Re("save cache for",t),this.cache.set(n,a)},()=>{}),o})}hasResult(e){const t=this.cacheUrl(e),n=Oe(e)||Qt(e)?this.cache.get(t):this.m3u8SegmentCache.get(t);return n!=null&&pt(n)}do(e,t,n,r,i){return v(this,null,function*(){let o;Re("schedule for",t);const a=yield this.schedule(e,t),u=r?a.hosts:a.ips;Re("scheduled for",t);for(let f=0;f<n;f++){const c=bs(u);if(c==null)break;try{Re(`do with ${r?"host":"IP"}`,c,t),yield i(c.addr),a.expireAt=Date.now()+a.ttl*1e3;return}catch(p){if(console.warn("do job with",c.addr,"failed:",p,t),o=p,se(p))break;Ne(p)&&(c.after=Date.now()+gs)}}throw o=se(o)?o:new ft(o),o})}}function wt(s,e=Date.now()){return s.after<e}function bs(s){for(const e of s)if(wt(e))return e;return null}function pt(s){const e=Date.now();return s.expireAt<=e?!1:s.hosts.some(t=>wt(t,e))&&s.ips.some(t=>wt(t,e))}class vs{constructor(){R(this,"locked",!1);R(this,"waitings",[]);this.unlock=this.unlock.bind(this)}lock(){return v(this,null,function*(){return this.locked?(yield new Promise(e=>{this.waitings.push(e)}),this.unlock):(this.locked=!0,this.unlock)})}unlock(){if(this.waitings.length===0){this.locked=!1;return}this.waitings.shift()()}runExclusive(e){return v(this,null,function*(){const t=yield this.lock();try{return yield e()}catch(n){throw n}finally{t()}})}}const sn="0.10.2-fix-traffic.2";function ys(){var r,i;const{os:s,device:e,browser:t}=ut(navigator.userAgent);let n;return typeof window!="undefined"?n=window.location:typeof self!==void 0&&(n=self.location),{os:`${s.name}_${s.version}`,browser:`${t.name}_${t.version}`,app:(r=n==null?void 0:n.host)!=null?r:"",sdk:`Web SDK v${sn}`,dev_model:(i=e.model)!=null?i:"",dev_id:""}}const mt=200,gt=j("log");class Rs{constructor(e,t,n,r,i){R(this,"env",Ht(ys()));R(this,"flushMutex",new vs);R(this,"buffer",[]);this.schemaName=e,this.fetch=t,this.flushNum=n,this.flushWait=r,this.app=i}callApiLog(e){return v(this,null,function*(){const t=this.fetch;try{const n=it({appID:this.app.appID,appSalt:this.app.appSalt,path:`${Pt}/v1/log/${this.schemaName}`}),r=yield t(new Request(`${Pt}/v1/log/${this.schemaName}`,{method:"POST",headers:{Authorization:n,"Content-Type":"text/csv","X-Env":this.env},body:Ss(e)}));if(!r.ok)throw new Error(`Unexpected response status: ${r.status} ${r.statusText}`)}catch(n){console.warn("Call log API failed:",n)}})}flush(){return v(this,null,function*(){return this.flushMutex.runExclusive(()=>v(this,null,function*(){const e=this.buffer.splice(0);if(e.length===0)return;const t=Math.ceil(e.length/mt);return Promise.all(Array.from({length:t}).map((n,r)=>this.callApiLog(e.slice(r*mt,(r+1)*mt))))}))})}tryFlush(){return v(this,null,function*(){const e=yield this.flushMutex.runExclusive(()=>{const t=this.buffer;if(t.length===0)return!1;if(t.length>=this.flushNum)return gt("buffer.length >= this.flushNum"),!0;const n=Date.now()-t[0].ts;return n>=this.flushWait*1e3?(gt("waited >= this.flushWait"),!0):this.flushWait*1e3-n});if(e===!0)return this.flush();typeof e=="number"&&setTimeout(()=>this.tryFlush(),e)})}log(e){this.buffer.push(T({ts:Date.now()},e)),this.tryFlush()}}class bt{constructor(e,t=self.fetch,n=100,r=30){R(this,"schemaLoggers",new Map);this.appInfo=e,this.fetch=t,this.flushNum=n,this.flushWait=r}log(e,t){gt("log",e,t);let n=this.schemaLoggers.get(e);n==null&&(n=new Rs(e,this.fetch,this.flushNum,this.flushWait,this.appInfo),this.schemaLoggers.set(e,n)),n.log(t)}}function Ss(s){const e=Object.keys(s[0]),t=["ts",...e.filter(i=>i!=="ts")],n=t.map(rn).join(","),r=s.map(i=>t.map(o=>i[o]).map(o=>o!=null?o+"":"").map(rn).join(","));return[n,...r].join(`
`)}function rn(s){let e=s.replace(/"/g,'""');return/("|,|\n)/.test(e)&&(e='"'+e+'"'),e}class Es{constructor(e,t){R(this,"db");this.dbName=e,this.storeConfigs=t}getDB(){return v(this,null,function*(){return this.db!=null?this.db:new Promise(e=>{const t=indexedDB.open(this.dbName);t.addEventListener("upgradeneeded",()=>{for(const n of this.storeConfigs){const r=t.result.createObjectStore(n.name);for(const i of n.indexes)r.createIndex(i.name,i.keyPath)}}),e(Fe(t))})})}get(e,t){return v(this,null,function*(){const r=(yield this.getDB()).transaction(e,"readonly").objectStore(e).get(t);return Fe(r)})}getAll(e){return v(this,null,function*(){const n=(yield this.getDB()).transaction(e,"readonly").objectStore(e).getAll();return Fe(n)})}count(e){return v(this,null,function*(){const n=(yield this.getDB()).transaction(e,"readonly").objectStore(e).count();return Fe(n)})}set(e,t,n){return v(this,null,function*(){const i=(yield this.getDB()).transaction(e,"readwrite");return i.objectStore(e).put(n,t),vt(i)})}remove(e,t){return v(this,null,function*(){const r=(yield this.getDB()).transaction(e,"readwrite");return r.objectStore(e).delete(t),vt(r)})}clear(){return v(this,null,function*(){const e=yield this.getDB();yield Promise.all(this.storeConfigs.map(({name:t})=>{const n=e.transaction(t,"readwrite");return n.objectStore(t).clear(),vt(n)}))})}walkBy(e,t,n){return v(this,null,function*(){const i=(yield this.getDB()).transaction(e,"readonly").objectStore(e).index(t).openCursor(void 0,"next");return new Promise((o,a)=>{i.addEventListener("error",()=>a(new Se(i.error))),i.addEventListener("success",()=>{const u=i.result;if(u==null){o();return}n(u.value,u.primaryKey),u.continue()})})})}dispose(){var e;(e=this.db)==null||e.close()}}class Se extends Error{constructor(t){super(t+"");R(this,"name","IndexedDBError");this.cause=t}}function Fe(s){return new Promise((e,t)=>{s.addEventListener("success",()=>e(s.result)),s.addEventListener("error",()=>t(new Se(s.error)))})}function vt(s){return new Promise((e,t)=>{s.addEventListener("complete",()=>e()),s.addEventListener("error",()=>t(new Se(s.error))),s.addEventListener("abort",()=>t(new Se(s.error)))})}class Cs{constructor(){R(this,"front",null);R(this,"back",null)}insertElementBefore(e,t){const n=t.prev;n!=null?(n.next=e,e.prev=n):this.front=e,t.prev=e,e.next=t}insertElementAfter(e,t){const n=t.next;n!=null?(n.prev=e,e.next=n):this.back=e,t.next=e,e.prev=t}pushElementFront(e){const t=this.front;t!=null?(t.prev=e,e.next=t):this.back=e,this.front=e}pushElementBack(e){const t=this.back;t!=null?(t.next=e,e.prev=t):this.front=e,this.back=e}moveBefore(e,t){e!==t&&(this.remove(e),this.insertElementBefore(e,t))}moveAfter(e,t){e!==t&&(this.remove(e),this.insertElementAfter(e,t))}moveToFront(e){this.remove(e),this.pushElementFront(e)}moveToBack(e){this.remove(e),this.pushElementBack(e)}insertBefore(e,t){const n={value:e,prev:null,next:null};return this.insertElementBefore(n,t),n}insertAfter(e,t){const n={value:e,prev:null,next:null};return this.insertElementAfter(n,t),n}pushFront(e){const t={value:e,prev:null,next:null};return this.pushElementFront(t),t}pushBack(e){const t={value:e,prev:null,next:null};return this.pushElementBack(t),t}remove(e){const t=e.prev,n=e.next;return t!=null?(t.next=n,e.prev=null):this.front=n,n!=null?(n.prev=t,e.next=null):this.back=t,e.value}walk(e){let t=this.front;for(;t!=null;){if(e(t.value,t)===!1)return;t=t.next}}reverseWalk(e){let t=this.back;for(;t!=null;){if(e(t.value,t)===!1)return;t=t.prev}}}const yt=j("dc/size-control");class xs{constructor(e){R(this,"inited");R(this,"itemElementMap",new Map);R(this,"itemList",new Cs);this.dc=e,this.inited=this.dc.walkItems((t,n)=>{const r={key:n,usedTime:t.usedTime,size:Rt(t)},i=this.itemList.pushBack(r);this.itemElementMap.set(n,i)})}addItem(e,t){const n={key:e,usedTime:t.usedTime,size:Rt(t)};let r=null;return this.itemList.reverseWalk((i,o)=>{if(i.usedTime<=t.usedTime)return r=this.itemList.insertAfter(n,o),!1}),r==null&&(r=this.itemList.pushFront(n)),this.itemElementMap.set(e,r),r}removeItem(e){const t=this.itemElementMap.get(e);t!=null&&(this.itemElementMap.delete(e),this.itemList.remove(t))}onItemSet(e,t){return v(this,null,function*(){yield this.inited;let n=this.itemElementMap.get(e);if(n==null){this.addItem(e,t);return}n.value.size=Rt(t),t.usedTime!==n.value.usedTime&&(n.value.usedTime=t.usedTime,this.itemList.moveToBack(n))})}getLeftSpace(){return v(this,null,function*(){if(typeof navigator.storage.estimate=="undefined")return null;const{quota:e,usage:t}=yield navigator.storage.estimate();return e!=null&&t!=null?e-t:null})}freeUpSpace(e){return v(this,null,function*(){yield this.inited;let t=0;const n=[];this.itemList.walk(({key:r,size:i})=>{if(i!==0&&(n.push(r),t+=i,t>=e))return!1}),yt("to free up space, remove",n),yield Promise.all(n.map(r=>v(this,null,function*(){yield this.dc.removeItemWithContent(r),this.removeItem(r)})))})}beforeContentSet(e,t,n){return v(this,null,function*(){if(n==null)return;yield this.inited;const r=yield this.getLeftSpace();if(r!=null&&r<n){const i=n-r;yt("freeUpSpace for",e,t,i),yield this.freeUpSpace(i)}})}onQuotaExceeded(e,t,n){return v(this,null,function*(){yt("quota exceeded",e,t,n),n!=null&&(yield this.freeUpSpace(n))})}}function _s([s,e],t){return e=e!=null?e:t,e!=null?e-s:0}function Rt(s){return s.pieces.reduce((e,t)=>{var n,r;return e+_s(t,(r=(n=s.meta)==null?void 0:n.fsize)!=null?r:null)},0)}const Ts=j("dc"),As="miku/dc/v3",Ee="item",on="usedTimeIndex",ks={name:Ee,indexes:[{name:on,keyPath:"usedTime"}]};class Ds{constructor(e={},t=As){R(this,"db");R(this,"cr");R(this,"browserCache",null);R(this,"browserCachePromise",null);this.config=e,this.ns=t,this.db=new Es(this.ns,[ks]),this.cr=new xs(this)}openBrowserCache(){return v(this,null,function*(){return this.browserCachePromise!=null?this.browserCachePromise:(this.browserCachePromise=caches.open(this.ns).catch(e=>{throw new ue(e)}),this.browserCachePromise.then(e=>{this.browserCache=e}),this.browserCachePromise)})}getItem(e){return v(this,null,function*(){return this.db.get(Ee,e)})}setItem(e,t){return v(this,null,function*(){Ts("setItem",e,t),yield this.db.set(Ee,e,t),yield this.cr.onItemSet(e,t)})}walkItems(e){return v(this,null,function*(){return this.db.walkBy(Ee,on,e)})}removeItemWithContent(e){return v(this,null,function*(){const t=yield this.getItem(e);t!=null&&(yield Promise.all(t.pieces.map(n=>this.removeContent(e,n))),yield this.db.remove(Ee,e))})}browserCacheMatch(e){return v(this,null,function*(){let t=this.browserCache;return t==null&&(t=yield this.openBrowserCache()),t.match(e).catch(n=>{throw new ue(n)})})}browserCachePut(e,t){return v(this,null,function*(){let n=this.browserCache;n==null&&(n=yield this.openBrowserCache()),yield n.put(e,t).catch(r=>{throw new ue(r)})})}browserCacheDelete(e){return v(this,null,function*(){let t=this.browserCache;t==null&&(t=yield this.openBrowserCache()),yield t.delete(e).catch(n=>{throw new ue(n)})})}getContent(e,t){return v(this,null,function*(){const n=yield this.browserCacheMatch(St(e,t));if(n==null)return;if(n.body==null)throw new Error("Body expected for cached response");return Ue(n)})}setContent(e,t,n){return v(this,null,function*(){const r=St(e,t),i=te(n.headers);yield this.cr.beforeContentSet(e,t,i);let o;if(!He())o=n.underlayer;else{const{headers:a,body:u}=n;o=new Response(u,{status:200,statusText:"OK",headers:a})}try{yield this.browserCachePut(r,o)}catch(a){throw a instanceof ue&&a.cause instanceof Error&&a.cause.name==="QuotaExceededError"&&this.cr.onQuotaExceeded(e,t,i),a}})}removeContent(e,t){return v(this,null,function*(){const n=St(e,t);return this.browserCacheDelete(n)})}dispose(){this.db.dispose()}}function St(s,e){var t;return`${s}_with_range_${e[0]}_${(t=e[1])!=null?t:""}`}class ue extends Error{constructor(t){super(t+"");R(this,"name","BrowserCacheError");this.cause=t}}class he{constructor(e){R(this,"value");this.value=e!=null?T({},e.value):{}}set(e,t){this.value[e]=t}get(e){return this.value[e]}}class Is{constructor(e){this.logger=e}log(e){return this.logger.log("DownloadLog",e)}}class Ls{constructor(e){this.logger=e}log(e){return this.logger.log("DoLog",e)}}const Ce=j("utils/fetch");function an(s){return v(this,null,function*(){var l;const e=yield fetch(s),t=me(s.headers);if(t==null||e.status!==206||e.body==null)return e;const{body:n,status:r,statusText:i,headers:o}=e,a=100;let u=(l=t.start)!=null?l:0,f=n.getReader(),c=null;const p=new ReadableStream({pull:h=>v(this,null,function*(){c!=null&&(clearTimeout(c),c=null),f==null&&(Ce("resume on pull"),s.headers.set("range",Be($(T({},t),{start:u}))),f=(yield fetch(s)).body.getReader());const{value:d,done:w}=yield f.read();if(w){Ce("read done"),h.close();return}try{h.enqueue(d)}catch(b){Ce("enqueue failed:",b),f==null||f.cancel("target stream enqueue failed");return}u+=d.byteLength,c=setTimeout(()=>v(this,null,function*(){c=null,f!=null&&(Ce("cancel after long time no pull"),f.cancel("long time no read"),f=null)}),a)}),cancel:h=>{Ce("cancel",h),f==null||f.cancel(h)}});return new Response(p,{status:r,statusText:i,headers:o})})}const Bs=3,Et=j("http");class ln{constructor(e,t,n=0){R(this,"downloadLogger");R(this,"doLogger");this.client=t,this.clientResponseTimeout=n,this.downloadLogger=new Is(e),this.doLogger=new Ls(e)}doWithResolved(e,t,n,r){return v(this,null,function*(){var f;const i=new URL(t.url).host,o=Date.now();let a,u;try{Et("fetch",t.url,"with resolved",n);const c=new AbortController;Gt(c,t.signal);const p=new le(t.url,$(T({},t),{signal:c.signal}));p.headers.set("X-Miku-Agent",`web-miku/v${sn}`);let l=this.client.fetch(e,p,n);this.clientResponseTimeout>0&&(l=Promise.race([l,Xn(this.clientResponseTimeout)]),l.catch(d=>{d instanceof Vt&&c.abort(d)}));const h=yield l;if(Et("fetch",t.url,"succeeded with status",h.status),e.set("downloadStatus",h.status),e.set("downloadReqID",(f=h.headers.get("x-reqid"))!=null?f:""),h.status===429||h.status>=500)throw new ze(h);return u=h,u}catch(c){throw Et("fetch",t.url,"with resolved",n,"failed:",c),a=c,c}finally{const c=t.headers.get("Range"),p=c==null?null:Ot(c),l=e.get("downloadReqMessageAt"),h=e.get("downloadConnectionAt"),d=e.get("downloadStartTransferAt"),w=e.get("downloadRespMessageAt"),b=g=>{var y,E,k,I,q,z,W;return this.downloadLogger.log(T({ip:n.split(":")[0],domain:i,range_st:(y=p==null?void 0:p.start)!=null?y:-1,range_end:(E=p==null?void 0:p.end)!=null?E:-1,retry:r,ftask_id:(k=e.get("downloadFileTaskID"))!=null?k:"",task_id:(I=e.get("taskID"))!=null?I:"",d_id:(q=e.get("doID"))!=null?q:"",ts_st:o,r_id:(z=e.get("downloadReqID"))!=null?z:"",status_code:(W=e.get("downloadStatus"))!=null?W:-1,t_req_msg:U(l,o),t_conn:U(h,l!=null?l:o),t_tls:-1,t_st_trans:U(d,h),t_resp_msg:U(w,d),err_msg:"",err_desc:"",t_content_trans:-1,t_total:-1,resp_size:-1},g))},S=g=>{const y=Date.now();b(T({t_total:U(y,o)},ge(g)))},m=g=>{const y=Date.now();b({t_content_trans:U(y,w!=null?w:d),t_total:U(y,o),resp_size:g})};u==null?S(a):u.bodyReadResult.then(g=>{g.success?m(g.size):S(g.error)})}})}originalDo(e,t){return v(this,null,function*(){if(t.signal.aborted)throw t.signal.reason;let n=-1,r;if(yield this.client.resolve(e,t,Bs,i=>v(this,null,function*(){n++;const o=new he(e);r=yield this.doWithResolved(o,t,i,n)})),r==null)throw new Error(`Http do failed: resolver do finished with no finalResp, url: ${t.url}`);return r})}do(e,t){return v(this,null,function*(){const n=Date.now(),r=ot();e.set("doID",r);let i,o=null;try{return i=yield this.originalDo(e,t),i}catch(a){throw o=a,a}finally{const{onDoError:a,onDoResponsed:u}=this.getDoLog(e,r,n);i==null?a(o):u(i.status)}})}getDoLog(e,t,n){const r=a=>{var u;return this.doLogger.log(T({lookup_type:!0,t_lookup:(u=e.get("dnsResolveFromCache")===!0?0:e.get("dnsResolveTotalTime"))!=null?u:-1,t_total:-1,ts_st:n,err_desc:"",err_msg:"",status_code:-1,task_id:e.get("taskID"),id:t},a))};return{onDoError:a=>{const u=Date.now();r(T({t_total:U(u,n)},ge(a)))},onDoResponsed:a=>{const u=Date.now();r({t_total:U(u,n),status_code:a})}}}}const Ps=443;function Ms(s,e){const{url:t,headers:n,method:r,redirect:i,signal:o}=s,a=new URL(t),u=a.host,[f,c]=Yt(e),p=c+Ps;return a.protocol="https:",a.host=`${f}:${p}`,a.pathname=`/${u}${a.pathname}`,cn(a.toString(),{headers:n,method:r,redirect:i,signal:o})}function cn(s,e){return new Request(s,T({mode:"cors",credentials:"omit"},e))}function un(s,e){return v(this,null,function*(){const o=e,{url:t}=o,n=Ie(o,["url"]),r=cn(t,n),i=yield an(r);return Ue(i)})}class Os{constructor(e){this.logger=e}log(e){return this.logger.log("TaskLog",e)}}class hn{constructor(e,t,n,r){R(this,"id",ot());R(this,"priority",0);R(this,"signal");R(this,"started",!1);R(this,"taskLogger");this.url=e,this.range=t,this.startByClient=r,this.taskLogger=new Os(n)}setPriority(e){this.priority=e}start(e){return v(this,null,function*(){if(this.started)throw new Error("Task already started");if(this.started=!0,this.signal=e,e&&e.aborted)throw e.reason;const t=Date.now(),n=new he;n.set("taskID",this.id);let r,i=null;try{return r=yield this.startByClient(n,this),r}catch(o){throw i=o,o}finally{const{logOnError:o,logOnTransfered:a}=this.log(n,t);r==null?o(i):r.underlayer.bodyReadResult.then(u=>{u.success?a():o(u.error)})}})}log(e,t){const n=e.get("taskCacheMatchAt"),r=e.get("task1stHttpDoAt"),i=e.get("taskResultStreamAt"),o=Date.now(),a=c=>{var p,l,h,d,w;return this.taskLogger.log(T({type:(p=e.get("taskType"))!=null?p:1,id:this.id,url:this.url,err_msg:"",err_desc:"",range_st:(h=(l=this.range)==null?void 0:l.start)!=null?h:-1,range_end:(w=(d=this.range)==null?void 0:d.end)!=null?w:-1,ts_st:t,t_cc_match:U(n,t),t_http_do:U(r,n),t_res_stream:U(i,n),t_res:U(o,i),t_trans:-1,t_total:-1},c))};return{logOnError:c=>{const p=Date.now();a(T({t_total:U(p,t)},ge(c)))},logOnTransfered:()=>{const c=Date.now();a({t_trans:U(c,o),t_total:U(c,t)})}}}}class dn{constructor(e,t,n,r,i){this.stream=e,this.size=t,this.fileSize=n,this.contentType=r,this.underlayer=i}blob(){return v(this,null,function*(){const t=this.stream.getReader(),n=[];for(;;){const{done:r,value:i}=yield t.read();if(r)break;const o=i;n.push(o)}return new Blob(n)})}}function Ct(s,e,t){return s!=null&&t!=null&&t>=s&&(t=null),(e==null||e<0)&&(e=0),[e,t]}function fn(s,e){var r;const t=((r=e[0])!=null?r:0)===0,n=e[1]==null||s!=null&&e[1]===s;return t&&n}function Hs(s,e){var r,i;const t=(r=e[0])!=null?r:0,n=(i=e[1])!=null?i:s;return n==null?null:n-t}function Us(s,e,t){var u,f;if(e===0)return[];const n=(c,p)=>Fs(c,p,e!=null?e:Number.POSITIVE_INFINITY),r=(u=s==null?void 0:s[0])!=null?u:0,i=(f=s==null?void 0:s[1])!=null?f:e,o=[];let a=r;for(const c of t){if(a==null||e!=null&&c[1]!=null&&c[1]>e)break;if(!(c[1]!=null&&a>=c[1])){if(i==null||i>c[0]){c[0]>a&&o.push({cached:!1,range:Ct(e,a,c[0])});const p=n(c[0],a)?c[0]:a,l=n(c[1],i)?i:c[1];n(l,p)&&(o.push({cached:!0,range:Ct(e,p,l)}),a=l);continue}break}}return n(i,a)&&o.push({cached:!1,range:Ct(e,a,i)}),o}function zs(s,e){var r;const t=(r=e[0])!=null?r:0,n=e[1];for(const i of s){if(i[1]!=null&&i[1]<=t)continue;if(i[0]>t)break;const o=t-i[0],a=Ws(n!=null?n:i[1],i[0]);return{piece:i,start:o,end:a}}throw new Error("Piece not found")}function Ns(s,e){return s.some(t=>t[0]===e[0]&&t[1]===e[1])?s:[...s,e].sort((t,n)=>t[0]-n[0])}function Fs(s,e,t){const n=s!=null?s:t,r=e!=null?e:t;return n>r}function Ws(s,e){return s==null||e==null?null:s-e}function wn(s){const e={},t=s.split(",").map(n=>{let[r,i]=n.split("=").map(o=>o.trim());return[r.toLowerCase(),i]});for(const[n,r]of t)if(n==="max-age"){if(r!=null){const i=parseInt(r,10);Number.isNaN(i)||(e["max-age"]=i)}}else(n==="no-cache"||n==="no-store")&&(e[n]=!0);return e}function We(s){return Math.floor(s/1e3)}function pn(s,e){const t=s.get("Date");if(t==null)return e;const n=Date.parse(t);return Number.isNaN(n)?e:n}function $s(s,e,t){if(s!=null)return s;const n=e.get("Expires");if(n!=null){let r=Date.parse(n);Number.isNaN(r)&&(r=0);const i=pn(e,t);return We(r-i)}return 60*60}function qs(s){const e=s.get("Age");if(e==null)return 0;const t=parseInt(e,10);return Number.isNaN(t)?0:t}function js(s,e,t,n){const r=qs(s),i=pn(s,t),o=Math.max(0,We(t-i)),a=We(t-e),u=r+a,f=Math.max(o,u),c=We(n-t);return f+c}function Vs(s,e,t,n,r){var u;const i=(u=s==null?void 0:s["max-age"])!=null?u:null,o=$s(i,e,n),a=js(e,t,n,r);return o>a}function Gs(s,e,t,n){const r=s.get("Cache-Control"),i=r!=null?wn(r):null;return(i==null?void 0:i["no-cache"])===!0?!0:!Vs(i,s,e,t,n)}function Ks(s){const e=s.get("Cache-Control"),t=e!=null?wn(e):null;return!(t!=null&&t["no-store"]===!0)}function Xs(s){const e=s.get("ETag");return e==null?null:e.startsWith("W/")?e.slice(2):e}function Ys(s,e){const t=new Headers(s),n=Xs(e);n!=null&&t.set("If-None-Match",n);const r=e.get("Last-Modified");return r!=null&&t.set("If-Modified-Since",r),t}function Qs(s,e){return!(s.get("Last-Modified")===e.get("Last-Modified")&&s.get("ETag")===e.get("ETag"))}function Zs(s,e){const t=new Headers(s);return e.forEach((n,r)=>{r=r.toLowerCase(),!(r==="content-length"||r==="content-encoding"||r==="content-range")&&t.set(r,n)}),t}const Js={threshold:1024*1024*2,contentRangeExposed:!0},M=j("ftask");class er{constructor(e,t,n,r,i,o){R(this,"id",ot());R(this,"inited");R(this,"meta",null);R(this,"cachePieces",[]);R(this,"usedTime",0);this.cache=e,this.http=t,this.key=n,this.url=r,this.patterns=i,this.mediaOptimization=o,this.inited=this.resume()}fileSize(){var e,t;return(t=(e=this.meta)==null?void 0:e.fsize)!=null?t:null}cacheValidationRequired(){if(this.meta==null)return!1;const{requestTime:e,responseTime:t,headers:n}=this.meta;return e==null||t==null||n==null?!1:Gs(n,e,t,Date.now())}startTask(e,t){return v(this,null,function*(){var a,u;M("startTask",t.url);let n;const r=t.range!=null?[t.range.start,t.range.end]:[0,null];if(yield this.inited,this.usedTime=Date.now(),this.save(),ve())n=yield this.readRangeByPieces(e,t,r);else{M("supportStreamOperation: false",t.url,t.id);const f=[(a=r[0])!=null?a:0,r[1]],c=(u=yield this.cache.getContent(this.key,f))!=null?u:null;if(e.set("taskCacheMatchAt",Date.now()),c!=null&&!this.cacheValidationRequired())M("use cache",t.url,t.id),n=c;else if(M("doRequestAndSaveCache",t.url,t.id,c!=null),n=yield this.doRequestAndSaveCache(e,t,r,c!=null),n.status===304){if(c==null)throw new Error("Unexpected 304 with no cached response");n=c}e.set("taskResultStreamAt",Date.now())}const i=this.meta;if(i==null)throw new Error("Missing meta in fileTask");M("startTask resolved",t.url,t.id);const o=Hs(i.fsize,r);return new dn(n.body,o,i.fsize,i.headers.get("Content-Type"),n)})}readRangeByPieces(e,t,n){return v(this,null,function*(){const r=this.cacheValidationRequired();M("cacheValidationRequired",r);const i=Us(n,this.fileSize(),this.cachePieces);if(M("applyRange",n,this.fileSize(),this.cachePieces,i),r){const u=i.some(c=>c.cached),f=yield this.doRequestAndSaveCache(e,t,n,u);if(f.status===200||f.status===206)return f}e.set("taskCacheMatchAt",Date.now());const o=new TransformStream(void 0),a=yield new Promise((u,f)=>v(this,null,function*(){try{for(let c=0;c<i.length;c++){const{cached:p,range:l}=i[c];let h=null;p&&(h=yield this.readPieceFromLocal(e,t,l)),h==null&&(h=yield this.readPieceFromRemote(e,t,l)),c===0&&u(h);const w=c===i.length-1;yield h.body.pipeTo(o.writable,{preventClose:!w})}}catch(c){c!=null&&console.warn("readRange stream error for",this.url,c),o.writable.abort(c),f(c)}}));return e.set("taskResultStreamAt",Date.now()),new ne(o.readable,a)})}readPieceFromLocal(e,t,n){return v(this,null,function*(){M("readPieceFromLocal",t.url,n);const{piece:r,start:i,end:o}=zs(this.cachePieces,n),a=yield this.cache.getContent(this.key,r);return a==null?(console.warn(`Missing cache item: ${this.key} [${r})`),null):new ne(lt(a.body,[i,o]),a)})}readPieceFromRemote(e,t,n){return v(this,null,function*(){M("readPieceFromRemote",t.url,n);const r=yield this.doRequestAndSaveCache(e,t,n,!1);return!fn(this.fileSize(),n)&&r.status===200?(console.warn("Range request not supported for",this.url),new ne(lt(r.body,n),r)):r})}doRequest(e,t,n,r){return v(this,null,function*(){var h;e.get("task1stHttpDoAt")==null&&e.set("task1stHttpDoAt",Date.now());const i=new he(e);i.set("downloadFileTaskID",this.id);let o=new Headers({"Accept-Encoding":"identity;q=1, *;q=0"});n!=null&&(t.range==null&&fn(this.fileSize(),n)||o.set("Range",Be({start:n[0],end:n[1]==null?null:n[1]-1})));const a=(h=this.meta)==null?void 0:h.headers;r&&a!=null&&(o=Ys(o,a));const u=new le(this.url,{method:"GET",headers:o,signal:t.signal}),f=Date.now();let c;!ve()||this.mediaOptimization.threshold<=0?c=yield this.http.do(i,u):c=yield tr((...d)=>this.http.do(...d),un,this.mediaOptimization,this.patterns)(i,u);const p=Date.now();if(c.body==null)throw new Error("Body expected");let l=c.headers;if(r&&a!=null&&c.status===304)M(`updateStoredHeaders for ${this.url}`),l=Zs(a,c.headers);else if(c.status!==200&&c.status!==206)throw new ze(c);return yield this.onResponse(l,f,p),c.bodyReadResult.then(d=>{M(`bodyReadResult for ${this.url}:`,d)}),c})}doRequestAndSaveCache(e,t,n,r){return v(this,null,function*(){const i=yield this.doRequest(e,t,n,r);return(i.status===200||i.status===206)&&Ks(i.headers)?this.saveCachePiece(t,n,i):i})}saveCachePiece(e,t,n){return v(this,null,function*(){var o,a;let r=n,i;if(ve()){const{main:u,minor:f}=ss(n.body);r=new ne(u,n),i=new ne(f,n)}else if(!e.range){const u=n.underlayer.clone();i=Ue(u)}if(i!=null){const u=[(o=t==null?void 0:t[0])!=null?o:0,(a=t==null?void 0:t[1])!=null?a:null];M("saveCachePiece",this.url,u),this.cache.setContent(this.key,u,i).then(()=>(this.cachePieces=Ns(this.cachePieces,u),this.save())).then(()=>M("saveCachePiece finish",this.url,u),f=>M("saveCachePiece failed",this.url,f))}return r})}onResponse(e,t,n){return v(this,null,function*(){const r=this.meta;this.meta={fsize:Nt(e),requestTime:t,responseTime:n,headers:e},(r==null?void 0:r.headers)!=null&&Qs(r.headers,e)&&(M(`${this.url} modified, clear local cache`),yield Promise.all(this.cachePieces.map(i=>this.cache.removeContent(this.key,i))),this.cachePieces=[]),this.save()})}resume(){return v(this,null,function*(){const e=yield this.cache.getItem(this.key);e==null||e.meta==null||(this.meta=$(T({},e.meta),{headers:e.meta.headers!=null?new Headers(e.meta.headers):null}),this.cachePieces=e.pieces)})}save(){return v(this,null,function*(){var r,i;const e=((r=this.meta)==null?void 0:r.headers)!=null?[...((i=this.meta)==null?void 0:i.headers).entries()]:null,n={meta:this.meta!=null?$(T({},this.meta),{headers:e}):null,pieces:this.cachePieces,usedTime:this.usedTime};yield this.cache.setItem(this.key,n)})}}function tr(s,e,{threshold:t,contentRangeExposed:n},r){return function(o,a){return v(this,null,function*(){var z,W;const q=a,{url:u}=q,f=Ie(q,["url"]),c=Me(u);if(a.method!=="GET"||!r.media.some(N=>N.test(c)))return s(o,a);M("doWithInitialOptimization",u);const p=new he(o),l=new le(u,f),d=yield((N,O)=>v(this,null,function*(){var ie;let re=null;const ee=me(O.headers);ee!=null&&!Mt(ee)&&!n&&(re=nr(u,f.headers,e));const K=yield e(N,O);if(ee!=null&&K.status===206&&!K.headers.get("Content-Range")){const fe=Mt(ee)?te(K.headers):yield re;if(fe!=null){const Te=et({start:ee.start,end:(ie=ee.end)!=null?ie:fe-1,totalSize:fe});K.headers.set("Content-Range",Te)}}return K}))(p,l),w=te(d.headers);if(w!=null&&w<=t)return d;const b=new Headers(f.headers),S=(z=me(b))!=null?z:{start:null,end:null};if(S.start=((W=S.start)!=null?W:0)+t,S.end!=null&&S.end<S.start)return d;M("doWithInitialOptimization followingRange",S),b.set("Range",Be(S));const m=new le(u,$(T({},f),{headers:b})),J=d,{body:g}=J,y=Ie(J,["body"]);if(g==null)throw new Error(`Body expected for initial response of ${u}`);const[E,k]=ts(g,t),I=new TransformStream;return E.pipeTo(I.writable,{preventClose:!0}).then(()=>v(this,null,function*(){M("doWithInitialOptimization initialBody transfered");let N;try{const O=yield s(o,m);if(O.body==null)throw new Error(`Body expected for following response of ${u}`);if(O.status===200)N=lt(O.body,[S.start,S.end==null?null:S.end+1]);else if(O.status===206)N=O.body;else throw new ze(O)}catch(O){if(xt(O))M("use fallback fetch for doWithInitialOptimization followingBody",O);else{M("doWithInitialOptimization get followingBody failed",O),I.writable.abort(O);return}}N==null?N=k:k.cancel(),N.pipeTo(I.writable).then(()=>M("doWithInitialOptimization followingBody transfered"),O=>M("doWithInitialOptimization followingBody transfer failed",O))}),N=>v(this,null,function*(){M("doWithInitialOptimization initialBody transfer failed",N)})),new ne(I.readable,y)})}}function nr(s,e,t){return v(this,null,function*(){const n=new Headers(e);n.delete("Range");const r=yield t(new he,new le(s,{method:"HEAD",headers:n}));return te(r.headers)})}function xt(s){return[ht,ce,dt,ft,Se,ue].some(e=>s instanceof e)}class $e{constructor(e,t=!0,n=an){this.resolver=e,this.https=t,this.nativeFetch=n}resolve(e,t,n,r){return v(this,null,function*(){return this.resolver.do(e,t.url,n,!0,r)})}fetch(e,t,n){return v(this,null,function*(){const r=this.nativeFetch,i=rr(t,n,this.https),o=yield r(i),a=Date.now();return e.set("downloadConnectionAt",a),e.set("downloadStartTransferAt",a),Ue(o)})}dispose(){}}function sr(s,e){return new Request(s,T({mode:"cors",credentials:"omit"},e))}function rr(s,e,t=!0){const{url:n,headers:r,method:i,signal:o}=s,a=new URL(n),u=a.host,f=new Headers(r),[c,p]=Yt(e),l=p+(t?443:80);a.protocol=t?"https:":"http:",a.host=`${c}:${l}`,a.pathname=`/${u}${a.pathname}`;let h=a.toString();if(f.has("X-Miku-Agent")){const d=f.get("X-Miku-Agent");f.delete("X-Miku-Agent");const w=h.includes("?")?"&":"?",b=["X-Miku-Agent",d].map(encodeURIComponent).join("=");h=h+w+b}return sr(h,{headers:f,method:i,signal:o})}function ir(s){const e=[],t=s.split(`
`).map(r=>r.trim()).filter(r=>r.length>0);if(t[0]!=="#EXTM3U")throw new Error("Invalid Extended M3U Playlist");let n=null;for(const r of t){if(r.startsWith("#")){r.startsWith("#EXTINF:")&&(n=r);continue}n!=null&&(e.push({uri:r}),n=null)}return e}const mn=j("client");class or{constructor(e,t){R(this,"fileTasks",new Map);R(this,"cache");R(this,"cacheUrlFn");R(this,"cdnResolver");R(this,"liveResolver");R(this,"http");R(this,"liveHttp");R(this,"liveOptimization");R(this,"patterns");R(this,"mediaOptimization");R(this,"logger");var o,a,u,f,c,p;t!=null&&t.debug&&Ln(),this.cache=new Ds(t==null?void 0:t.cache),this.cacheUrlFn=(o=t==null?void 0:t.cacheUrl)!=null?o:ar,this.logger=(a=t==null?void 0:t.logger)!=null?a:new bt(e),this.cdnResolver=new tn(this.logger,e,t==null?void 0:t.dnsResolver),this.liveResolver=(u=t==null?void 0:t.liveResolver)!=null?u:new nn(this.logger,e,t==null?void 0:t.scheduler);const n=(f=t==null?void 0:t.httpClient)!=null?f:new $e(this.cdnResolver),r=(c=t==null?void 0:t.liveHttpClient)!=null?c:new $e(this.liveResolver);this.patterns=T(T({},Kt),t==null?void 0:t.patterns),this.mediaOptimization=T(T({},Js),t==null?void 0:t.mediaOptimization),this.http=new ln(this.logger,n);const i=2e3;this.liveHttp=new ln(this.logger,r,i),this.liveOptimization=(p=t==null?void 0:t.liveOptimization)!=null?p:!0}createTask(e,t){const n=e.indexOf("#");return n>=0&&(e=e.slice(0,n)),new hn(e,t!=null?t:null,this.logger,(r,i)=>(r.set("taskType",1),this.startTask(r,i)))}createLiveTask(e,t){const n=e.indexOf("#");return n>=0&&(e=e.slice(0,n)),new hn(e,t!=null?t:null,this.logger,(r,i)=>(r.set("taskType",2),this.startLiveTask(r,i)))}startTask(e,t){const n=this.cacheUrlFn(t.url);let r=this.fileTasks.get(n);return r==null&&(r=new er(this.cache,this.http,n,t.url,this.patterns,this.mediaOptimization),this.fileTasks.set(n,r)),r.startTask(e,t)}saveM3u8SegmentResult(e,t){return v(this,null,function*(){const n=yield es(t),i=ir(n).map(o=>Qn(o.uri,e));mn("saveM3u8SegmentResult",Me(e),i.map(Me)),yield this.liveResolver.saveM3u8SegmentResult(e,i)})}startLiveTask(e,t){return v(this,null,function*(){const n={};t.range!=null&&(n.Range=Be({start:t.range.start,end:t.range.end==null?null:t.range.end-1}));const r=new le(t.url,{method:"GET",headers:n,signal:t.signal});let i,o=this.liveOptimization&&Oe(t.url)&&!this.liveResolver.hasResult(t.url);if(o){mn("use nativeDo for",t.url);const u=un(e,r);this.liveHttp.do(e,r).catch(f=>{console.warn("do failed when prefetch for liveOptimization:",f)}),i=yield u}else i=yield this.liveHttp.do(e,r);if(i.body==null)throw new Error("Body expected");if(i.status!==200&&i.status!==206)throw new Error(`Invalid response, status: ${i.status}`);let a=i.body;if(!o&&He()&&Oe(t.url)){const[u,f]=i.body.tee();this.saveM3u8SegmentResult(t.url,f).catch(c=>{console.warn("Save M3u8 segment cache failed:",t.url,c)}),a=u}return new dn(a,te(i.headers),Nt(i.headers),i.headers.get("Content-Type"),i)})}dispose(){this.cache.dispose()}}function ar(s){return s}function lr(s){return s&&s.mikuProxy===!0}const cr=j("proxy/common");function ur(s,e){return v(this,null,function*(){var d;const{browser:t}=ut(navigator.userAgent);if(t.name==="Firefox"&&e.headers.get("Range")){cr("Short circuit for Firefox:",e.url);const w=yield s.cdnResolver.resolve(new he,e.url,!0),b=Ms(e,w);return Response.redirect(b.url)}const n=me(e.headers),r=n==null?void 0:{start:n.start,end:n.end==null?null:n.end+1},i=s.createTask(e.url,r!=null?r:void 0);let o;try{o=yield i.start(e.signal)}catch(w){if(w instanceof ze){const{status:b,statusText:S,headers:m,body:g,underlayer:y}=w.response;return y!=null?y:new Response(g,{status:b,statusText:S,headers:m})}throw w}let{stream:a,contentType:u,size:f,fileSize:c,underlayer:p}=o;if(!ve())return p.underlayer;let l=zt(p==null?void 0:p.headers);return l.set("Accept-Ranges","bytes"),l.set("Access-Control-Allow-Origin","*"),l.set("Content-Type",u!=null?u:""),l.set("Content-Length",(f!=null?f:"")+""),l.set("Content-Transfer-Encoding","binary"),r!=null&&l.set("Content-Range",et({start:(d=r.start)!=null?d:0,end:r.end!=null?r.end-1:c!=null?c-1:null,totalSize:c})),new Response(a,{status:r==null?200:206,statusText:r==null?"OK":"Partial Content",headers:l})})}function hr(s,e){return v(this,null,function*(){var l;const t=me(e.headers),n=t==null?void 0:{start:t.start,end:t.end==null?null:t.end+1},r=s.createLiveTask(e.url,n!=null?n:void 0);let{stream:i,contentType:o,size:a,fileSize:u,underlayer:f}=yield r.start(e.signal);if(!He())return f.underlayer;let c=new Headers(f==null?void 0:f.headers);return c.set("Accept-Ranges","bytes"),c.set("Access-Control-Allow-Origin","*"),c.set("Content-Type",o!=null?o:""),c.set("Content-Length",(a!=null?a:"")+""),n!=null&&c.set("Content-Range",et({start:(l=n.start)!=null?l:0,end:n.end!=null?n.end-1:u!=null?u-1:null,totalSize:u})),new Response(i,{status:n==null?200:206,statusText:n==null?"OK":"Partial Content",headers:c})})}const dr="MIKU_PROXY_CONFIG";function fr(s){const e=s.split("?")[1];if(!e)throw new Error("Invalid script url");const n=new URLSearchParams(e).get(dr);if(n==null)throw new Error("Invalid script url: no config info");const r=JSON.parse(n),i=o=>o==null?void 0:o.map(({source:a,flags:u})=>new RegExp(a,u));return $(T({},r),{patterns:r.patterns==null?void 0:Gn(r.patterns,o=>i(o))})}function wr(s){return Array.isArray(s)?{cdn:s,live:[]}:T({cdn:[],live:[]},s)}function gn(s,e){const t=s.hostname;return e.includes("*")||e.includes(t)}class pr{constructor(){R(this,"windowFetchItemsMap",new Map)}onFetchItem(e,t,n,r,i){const o={url:t,ecdn:r,fallback:i!=null?i:!1,size:te(n.headers)};let a=this.windowFetchItemsMap.get(e);a==null&&(a=[],this.windowFetchItemsMap.set(e,a)),a.push(o)}onWindowClose(e){this.windowFetchItemsMap.delete(e)}getFetchItems(e){return this.windowFetchItemsMap.get(e)||[]}}function bn(t){return v(this,arguments,function*(s,e={}){const{url:n,headers:r,method:i,redirect:o,signal:a}=s,u=self.location.host,f=new URL(n).host;if(u===f)return fetch(s,e);const c=new Request(n,T({mode:"cors",credentials:"omit",headers:r,method:i,redirect:o,signal:a},e));try{return yield fetch(c)}catch(p){return console.warn("Request with CORS failed:",n,p),fetch(s)}})}class mr{constructor(e){this.logger=e}log(e){return this.logger.log("PageStatusLog",e)}}const qe=j("proxy/sw"),Q=new Map,xe=self,Z=fr(xe.location.href),vn=br(Z),_e=new pr,gr=new bt(Z.app,void 0,void 0,3),de=new mr(gr);xe.addEventListener("activate",s=>{s.waitUntil(xe.clients.claim()),ae.onRemove(e=>{_e.onWindowClose(e)})}),xe.addEventListener("fetch",s=>v(this,null,function*(){s.clientId!==""&&ae.add(s.clientId);const e=s.request;if(e.method==="GET"){const t=new URL(e.url),n=wr(Z.domains),r=T(T({},Kt),Z.patterns),i=new AbortController;if(Gt(i,s.request.signal),Object.defineProperty(e,"signal",{value:i.signal}),ae.whenRemoved(s.clientId,()=>i.abort(new Yn(`Source client ${s.clientId} closed`))),gn(t,n.cdn)&&Xt(t,r))return vr(s,e);if(gn(t,n.live)&&Xt(t,r,["live"]))return yr(s,e)}e.method==="GET"&&Z.statistics&&s.respondWith(bn(e).then(t=>{var n;return _e.onFetchItem(s.clientId,e.url,t,!1),de.log({r_id:(n=Q.get(s.clientId))!=null?n:"",text:t.statusText,code:t.status,url:e.url}),t}).catch(t=>{var n;return de.log({r_id:(n=Q.get(s.clientId))!=null?n:"",text:t instanceof Error?t.message:"",code:-1,url:e.url}),t}))})),xe.addEventListener("message",s=>v(this,null,function*(){if(s.source instanceof WindowClient&&!!lr(s.data))switch(qe("got proxy message",s.data,"from",s.source.id),s.data.type){case"window-available":ae.add(s.source.id);break;case"window-unavailable":ae.remove(s.source.id),Q.delete(s.source.id);break;case"get-window-fetch-items":const e=s.source.id,t=_e.getFetchItems(e),n=yield ae.get(e);if(n==null)throw new Error(`Invalid window client ID: ${e}`);const r={mikuProxy:!0,type:"window-fetch-items",items:t};n.postMessage(r);break;case"get-perf-rid":Q.set(s.source.id,s.data.rid)}}));function br(s){const e=T({debug:s.debug,patterns:s.patterns},s.client),t=new bt(s.app,void 0,void 0,3),n=new tn(t,s.app),r=new $e(n),i=new nn(t,s.app,void 0,e.cacheUrl),o=new $e(i);return new or(s.app,$(T({},e),{logger:t,httpClient:r,liveResolver:i,liveHttpClient:o}))}function vr(s,e){qe("use cdn",e.url),s.respondWith(ur(vn,e).then(t=>{var n;return Z.statistics&&(_e.onFetchItem(s.clientId,e.url,t,!0,!1),de.log({r_id:(n=Q.get(s.clientId))!=null?n:"",text:t.statusText,code:t.status,url:e.url})),t},t=>v(this,null,function*(){var n,r,i;if(xt(t))if(qe("Use fallback fetch for request",e.url,", error:",t),Z.statistics)try{const o=yield bn(e);return _e.onFetchItem(s.clientId,e.url,o,!0,!0),de.log({r_id:(n=Q.get(s.clientId))!=null?n:"",text:o.statusText,code:o.status,url:e.url}),o}catch(o){throw de.log({r_id:(r=Q.get(s.clientId))!=null?r:"",text:o instanceof Error?o.message:"",code:-1,url:e.url}),o}else return fetch(e);throw Z.statistics&&de.log({r_id:(i=Q.get(s.clientId))!=null?i:"",text:t instanceof Error?t.message:"",code:-1,url:e.url}),t})))}function yr(s,e){s.respondWith(hr(vn,e).then(void 0,t=>v(this,null,function*(){if(xt(t))return qe("Use fallback fetch for request",e.url,", error:",t),fetch(e);throw t})))}})();
